(function(T,Z){"undefined"!=typeof tabulator&&"undefined"==typeof tabulator.isExtension&&(tabulator.isExtension=!1);if("undefined"==typeof c)var c={};else{return c;throw"Internal error: RDF libray has already been loaded: $rdf already exists";}if(void 0!=c.log)throw"Internal Error: $rdf.log already defined,  util.js: "+c.log;c.log={debug:function(b){},warn:function(b){},info:function(b){},error:function(b){},success:function(b){},msg:function(b){}};c.Util={output:function(b){var a=document.createElement("div");
a.textContent=b;document.body.appendChild(a)},callbackify:function(b,a){b.callbacks={};for(var e=a.length-1;0<=e;e--)b.callbacks[a[e]]=[];b.addHook=function(a){b.callbacks[a]||(b.callbacks[a]=[])};b.addCallback=function(a,e){b.callbacks[a].push(e)};b.removeCallback=function(a,e){for(var d=0;d<b.callbacks[a].length;d++)if(b.callbacks[a][d].name==e)return b.callbacks[a].splice(d,1),!0;return!1};b.insertCallback=function(a,e){b.callbacks[a].unshift(e)};b.fireCallbacks=function(a,e){for(var d=[],g=[],
c=b.callbacks[a].length,l=c-1;0<=l;l--)b.callbacks[a][l].apply(b,e)&&d.push(b.callbacks[a][l]);for(l=d.length-1;0<=l;l--)g.push(d[l]);for(l=c;l<b.callbacks[a].length;l++)g.push(b.callbacks[a][l]);b.callbacks[a]=g}},XMLHTTPFactory:function(){if("undefined"!=typeof module&&module&&module.exports)return new (require("xmlhttprequest").XMLHttpRequest);if("undefined"!=typeof tabulator&&tabulator.isExtension)return Components.classes["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance().QueryInterface(Components.interfaces.nsIXMLHttpRequest);
if(window.XMLHttpRequest)return new window.XMLHttpRequest;if(window.ActiveXObject)try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(b){return new ActiveXObject("Microsoft.XMLHTTP")}else return!1},DOMParserFactory:function(){return tabulator&&tabulator.isExtension?Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser):window.DOMParser?new DOMParser:window.ActiveXObject?new ActiveXObject("Microsoft.XMLDOM"):!1},getHTTPHeaders:function(b){b=b.getAllResponseHeaders().split("\n");
for(var a={},e=void 0,f=0;f<b.length;f++)if(0<b[f].length){var h=b[f].split(": ");"undefined"==typeof h[1]?a[e]+="\n"+h[0]:(e=h[0].toLowerCase(),a[e]=h[1])}return a},dtstamp:function(){var b=new Date,a=b.getYear()+1900,e=b.getMonth()+1,f=b.getDate(),h=b.getUTCHours(),d=b.getUTCMinutes(),b=b.getSeconds();10>e&&(e="0"+e);10>f&&(f="0"+f);10>h&&(h="0"+h);10>d&&(d="0"+d);10>b&&(b="0"+b);return a+"-"+e+"-"+f+"T"+h+":"+d+":"+b+"Z"},enablePrivilege:"undefined"!=typeof netscape&&"undefined"!=typeof netscape.security.PrivilegeManager&&
netscape.security.PrivilegeManager.enablePrivilege||function(){},disablePrivilege:"undefined"!=typeof netscape&&"undefined"!=typeof netscape.security.PrivilegeManager&&netscape.security.PrivilegeManager.disablePrivilege||function(){},RDFArrayRemove:function(b,a){for(var e=0;e<b.length;e++)if(b[e].subject.sameTerm(a.subject)&&b[e].predicate.sameTerm(a.predicate)&&b[e].object.sameTerm(a.object)&&b[e].why.sameTerm(a.why)){b.splice(e,1);return}throw"RDFArrayRemove: Array did not contain "+a+" "+a.why;
},string_startswith:function(b,a){return b.slice(0,a.length)==a},AJAR_handleNewTerm:function(b,a,e){var f=null;if("undefined"!=typeof b.fetcher&&(f=b.fetcher,"symbol"==a.termType)){b=c.Util.uri.docpart(a.uri);var h;if(0>a.uri.indexOf("#")){if(c.Util.string_startswith(a.uri,"http://dbpedia.org/resource/Category:"))return;c.Util.string_startswith(a.uri,"http://purl.org/dc/elements/1.1/")||c.Util.string_startswith(a.uri,"http://purl.org/dc/terms/")?h="http://dublincore.org/2005/06/13/dcq":c.Util.string_startswith(a.uri,
"http://xmlns.com/wot/0.1/")?h="http://xmlns.com/wot/0.1/index.rdf":c.Util.string_startswith(a.uri,"http://web.resource.org/cc/")&&(h="http://web.resource.org/cc/schema.rdf")}h&&(b=h);f&&"unrequested"!=f.getState(b)||(h&&c.log.warn("Assuming server still broken, faking redirect of <"+a.uri+"> to <"+b+">"),f.requestURI(b,e))}},ArrayIndexOf:function(b,a,e){e||(e=0);var f=b.length;for(0>e&&(e=f+e);e<f;e++)if(b[e]===a)return e;return-1}};c.Util.variablesIn=function(b){for(var a=0;a<b.statements.length;a++){var e=
b.statatements[a],f={};e.subject instanceof c.Variable&&(f[e.subject.toNT()]=!0);e.predicate instanceof c.Variable&&(f[e.predicate.toNT()]=!0);e.object instanceof c.Variable&&(f[e.object.toNT()]=!0)}return f};c.Util.heavyCompare=function(b,a,e){var f=function(a){return"bnode"===a.termType?null:a},h=function(a){a=e.statementsMatching(b).map(function(a){return""+f(a.subject)+" "+f(a.predicate)+" "+f(a.object)}).concat(e.statementsMatching(void 0,void 0,b).map(function(a){return""+f(a.subject)+" "+f(a.predicate)+
" "+f(a.object)}));a.sort();return a.join("\n")};return"bnode"===b.termType||"bnode"===a.termType?0===b.compareTerm(a)?0:h(b)>h(a)?1:h(b)<h(a)?-1:b.compareTerm(a):b.compareTerm(a)};c.Util.heavyCompareSPO=function(b,a,e){var f=c.Util.heavyCompare,h=f(b.subject,a.subject,e);return h?h:(h=f(b.predicate,a.predicate,e))?h:f(b.object,a.object,e)};c.Util.parseXML=function(b){var a;if("undefined"!=typeof tabulator&&tabulator.isExtension)a=Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser);
else{if("undefined"!=typeof module&&module&&module.exports)return require("jsdom").jsdom(b,void 0,{});a=new DOMParser}return a.parseFromString(b,"application/xml")};c.Util.string={template:function(b,a){for(var e=b.split("%s"),f="",h=0;h<a.length;h++)a[h]+="",f+=e[h]+a[h];return f+e.slice(a.length).join()}};c.Util.extend=function(){var b=arguments[0]||{},a=1,e=arguments.length,f=!1,h,d,g,c;"boolean"===typeof b&&(f=b,b=arguments[1]||{},a=2);"object"===typeof b||jQuery.isFunction(b)||(b={});e===a&&
(b=this,--a);for(;a<e;a++)if(null!=(h=arguments[a]))for(d in h)g=b[d],c=h[d],b!==c&&(f&&c&&"object"===typeof c&&!c.nodeType?(g=g?g:jQuery.isArray(c)?[]:jQuery.isObject(c)?{}:c,b[d]=jQuery.extend(f,g,c)):void 0!==c&&(b[d]=c));return b};var C,N,R,H={}.hasOwnProperty;if("undefined"===typeof c||null===c)c={};null==c.Util&&(c.Util={});c.uri=function(){function b(){}b.join=function(a,e){var f,b,c,g;b=e.indexOf("#");0<b&&(e=e.slice(0,b));if(0===a.length)return e;if(0===a.indexOf("#"))return e+a;if(0<=a.indexOf(":"))return a;
f=e.indexOf(":");if(0===e.length)return a;if(0>f)return alert("Invalid base: "+e+" in join with given: "+a),a;b=e.slice(0,+f+1||9E9);if(0===a.indexOf("//"))return b+a;if(e.indexOf("//",f)===f+1){if(c=e.indexOf("/",f+3),0>c)return 0<e.length-f-3?e+"/"+a:b+a}else if(c=e.indexOf("/",f+1),0>c)return 0<e.length-f-1?e+"/"+a:b+a;if(0===a.indexOf("/"))return e.slice(0,c)+a;g=e.slice(c);f=g.lastIndexOf("/");if(0>f)return b+a;0<=f&&f<g.length-1&&(g=g.slice(0,+f+1||9E9));for(g+=a;g.match(/[^\/]*\/\.\.\//);)g=
g.replace(/[^\/]*\/\.\.\//,"");g=g.replace(/\.\//g,"");g=g.replace(/\/\.$/,"/");return e.slice(0,c)+g};b.commonHost=/^[-_a-zA-Z0-9.]+:(\/\/[^/]*)?\/[^/]*$/;b.hostpart=function(a){return(a=/[^\/]*\/\/([^\/]*)\//.exec(a))?a[1]:""};b.refTo=function(a,e){var f,b,d,g,k,l;if(!a)return e;if(a===e)return"";b=d=0;for(g=e.length;d<g&&(f=e[b],f===a[b]);b=++d);if(a.slice(0,b).match(c.Util.uri.commonHost)&&(f=e.indexOf("//"),0>f&&(f=-2),f=e.indexOf("/",f+2),"/"!==e[f+1]&&"/"!==a[f+1]&&e.slice(0,f)===a.slice(0,
f)))return e.slice(f);if("#"===e[b]&&a.length===b)return e.slice(b);for(;0<b&&"/"!==e[b-1];)b--;if(3>b||0<a.indexOf("//",b-2)||0<e.indexOf("//",b-2)||0<a.indexOf(":",b))return e;d=0;l=a.slice(b);g=0;for(k=l.length;g<k;g++)f=l[g],"/"===f&&d++;if(0===d&&b<e.length&&"#"===e[b])return"./"+e.slice(b);if(0===d&&b===e.length)return"./";f="";if(0<d)for(g=1;1<=d?g<=d:g>=d;1<=d?++g:--g)f+="../";return f+e.slice(b)};b.docpart=function(a){var e;e=a.indexOf("#");return 0>e?a:a.slice(0,e)};b.document=function(a){return c.sym(b.docpart(a.uri))};
b.protocol=function(a){var e;e=a.indexOf(":");return 0>e?null:a.slice(0,e)};return b}();c.Util.uri=c.uri;if(null!=("undefined"!==typeof module&&null!==module?module.exports:void 0)){null==(N=module.exports).Util&&(N.Util={});R=c.Util;for(C in R)H.call(R,C)&&(N=R[C],module.exports.Util[C]=N);module.exports.uri=c.uri}var H={}.hasOwnProperty,K=function(b,a){function e(){this.constructor=b}for(var f in a)H.call(a,f)&&(b[f]=a[f]);e.prototype=a.prototype;b.prototype=new e;b.__super__=a.prototype;return b},
Y=[].indexOf||function(b){for(var a=0,e=this.length;a<e;a++)if(a in this&&this[a]===b)return a;return-1};if("undefined"===typeof c||null===c)c={};c.Node=function(){function b(){}b.prototype.substitute=function(a){return this};return b}();c.Empty=function(b){function a(){return a.__super__.constructor.apply(this,arguments)}K(a,b);a.prototype.termType="empty";a.prototype.toString=function(){return"()"};a.prototype.toNT=a.prototype.toString;return a}(c.Node);c.Symbol=function(b){function a(a){this.value=
this.uri=a}K(a,b);a.prototype.termType="symbol";a.prototype.toString=function(){return"<"+this.uri+">"};a.prototype.toNT=a.prototype.toString;a.prototype.sameTerm=function(a){return a?this.termType===a.termType&&this.uri===a.uri:!1};a.prototype.compareTerm=function(a){return this.classOrder<a.classOrder?-1:this.classOrder>a.classOrder?1:this.uri<a.uri?-1:this.uri>a.uri?1:0};a.prototype.XSDboolean=new a("http://www.w3.org/2001/XMLSchema#boolean");a.prototype.XSDdecimal=new a("http://www.w3.org/2001/XMLSchema#decimal");
a.prototype.XSDfloat=new a("http://www.w3.org/2001/XMLSchema#float");a.prototype.XSDinteger=new a("http://www.w3.org/2001/XMLSchema#integer");a.prototype.XSDdateTime=new a("http://www.w3.org/2001/XMLSchema#dateTime");a.prototype.integer=new a("http://www.w3.org/2001/XMLSchema#integer");return a}(c.Node);null!=c.NextId?c.log.error("Attempt to re-zero existing blank node id counter at "+c.NextId):c.NextId=0;c.NTAnonymousNodePrefix="_:n";c.BlankNode=function(b){function a(a){this.id=c.NextId++;this.value=
a?a:this.id.toString()}K(a,b);a.prototype.termType="bnode";a.prototype.toNT=function(){return c.NTAnonymousNodePrefix+this.id};a.prototype.toString=a.prototype.toNT;a.prototype.sameTerm=function(a){return a?this.termType===a.termType&&this.id===a.id:!1};a.prototype.compareTerm=function(a){return this.classOrder<a.classOrder?-1:this.classOrder>a.classOrder?1:this.id<a.id?-1:this.id>a.id?1:0};return a}(c.Node);c.Literal=function(b){function a(a,f,b){this.value=a;this.lang=f;this.datatype=b;null==this.lang&&
(this.lang=void 0);null==this.datatype&&(this.datatype=void 0)}K(a,b);a.prototype.termType="literal";a.prototype.toString=function(){return""+this.value};a.prototype.toNT=function(){var a;a=this.value;if(!1===typeof a){if("number"===typeof a)return""+a;throw Error("Value of RDF literal is not string: "+a);}a=a.replace(/\\/g,"\\\\");a=a.replace(/\"/g,'\\"');a=a.replace(/\n/g,"\\n");a='"'+a+'"';this.datatype&&(a+="^^"+this.datatype.toNT());this.lang&&(a+="@"+this.lang);return a};a.prototype.sameTerm=
function(a){return a?this.termType===a.termType&&this.value===a.value&&this.lang===a.lang&&(!this.datatype&&!a.datatype||this.datatype&&this.datatype.sameTerm(a.datatype)):!1};a.prototype.compareTerm=function(a){return this.classOrder<a.classOrder?-1:this.classOrder>a.classOrder?1:this.value<a.value?-1:this.value>a.value?1:0};return a}(c.Node);c.Collection=function(b){function a(a){var f,b,d;this.id=c.NextId++;this.elements=[];this.closed=!1;if("undefined"!==typeof a)for(b=0,d=a.length;b<d;b++)f=
a[b],this.elements.push(c.term(f))}K(a,b);a.prototype.termType="collection";a.prototype.toNT=function(){return c.NTAnonymousNodePrefix+this.id};a.prototype.toString=function(){return"("+this.elements.join(" ")+")"};a.prototype.substitute=function(a){var f,b=c.Collection,d,g,k,l;k=this.elements;l=[];d=0;for(g=k.length;d<g;d++)f=k[d],l.push(f.substitute(a));return new b(l)};a.prototype.append=function(a){return this.elements.push(a)};a.prototype.unshift=function(a){return this.elements.unshift(a)};
a.prototype.shift=function(){return this.elements.shift()};a.prototype.close=function(){return this.closed=!0};return a}(c.Node);c.Collection.prototype.sameTerm=c.BlankNode.prototype.sameTerm;c.Collection.prototype.compareTerm=c.BlankNode.prototype.compareTerm;c.term=function(b){var a,e,f,h;switch(typeof b){case "object":if(b instanceof Date)return a=function(a){return(""+(100+a)).slice(1,3)},b=""+b.getUTCFullYear()+"-"+a(b.getUTCMonth()+1)+"-"+a(b.getUTCDate())+"T"+a(b.getUTCHours())+":"+a(b.getUTCMinutes())+
":"+a(b.getUTCSeconds())+"Z",new c.Literal(b,void 0,c.Symbol.prototype.XSDdateTime);if(b instanceof Array){e=new c.Collection;f=0;for(h=b.length;f<h;f++)a=b[f],e.append(c.term(a));return e}return b;case "string":return new c.Literal(b);case "number":return a=0<=(""+b).indexOf("e")?c.Symbol.prototype.XSDfloat:0<=(""+b).indexOf(".")?c.Symbol.prototype.XSDdecimal:c.Symbol.prototype.XSDinteger,new c.Literal(""+b,void 0,a);case "boolean":return new c.Literal(b?"1":"0",void 0,c.Symbol.prototype.XSDboolean);
case "undefined":return}throw"Can't make term from "+b+" of type "+typeof b;};c.Statement=function(){function b(a,e,f,b){this.subject=c.term(a);this.predicate=c.term(e);this.object=c.term(f);null!=b&&(this.why=b)}b.prototype.toNT=function(){return[this.subject.toNT(),this.predicate.toNT(),this.object.toNT()].join(" ")+" ."};b.prototype.toString=b.prototype.toNT;b.prototype.substitute=function(a){return new c.Statement(this.subject.substitute(a),this.predicate.substitute(a),this.object.substitute(a),
this.why)};return b}();c.st=function(b,a,e,f){return new c.Statement(b,a,e,f)};c.Formula=function(b){function a(){this.statements=[];this.constraints=[];this.initBindings=[];this.optional=[]}K(a,b);a.prototype.termType="formula";a.prototype.toNT=function(){return"{"+this.statements.join("\n")+"}"};a.prototype.toString=a.prototype.toNT;a.prototype.add=function(a,f,b,d){return this.statements.push(new c.Statement(a,f,b,d))};a.prototype.addStatement=function(a){return this.statements.push(a)};a.prototype.substitute=
function(a){var f,b,d,g,k;f=new c.Formula;k=this.statements;d=0;for(g=k.length;d<g;d++)b=k[d],f.addStatement(b.substitute(a));return f};a.prototype.sym=function(a,f){if(null!=f)throw"This feature (kb.sym with 2 args) is removed. Do not assume prefix mappings.";return new c.Symbol(a)};a.prototype.literal=function(a,f,b){return new c.Literal(""+a,f,b)};a.prototype.bnode=function(a){return new c.BlankNode(a)};a.prototype.formula=function(){return new c.Formula};a.prototype.collection=function(){return new c.Collection};
a.prototype.list=function(a){var f,b,d,g;b=new c.Collection;if(a)for(d=0,g=a.length;d<g;d++)f=a[d],b.append(f);return b};a.prototype.variable=function(a){return new c.Variable(a)};a.prototype.ns=function(a){return function(f){return new c.Symbol(a+(null!=f?f:""))}};a.prototype.fromNT=function(a){var f,b,d;switch(a[0]){case "<":return c.sym(a.slice(1,-1));case '"':f=d=void 0;b=a.lastIndexOf('"');if(b<a.length-1)if("@"===a[b+1])d=a.slice(b+2);else if("^^"===a.slice(b+1,b+3))f=c.fromNT(a.slice(b+3));
else throw"Can't convert string from NT: "+a;a=a.slice(1,b);a=a.replace(/\\"/g,'"');a=a.replace(/\\n/g,"\n");a=a.replace(/\\\\/g,"\\");return c.lit(a,d,f);case "_":return f=new c.BlankNode,f.id=parseInt(a.slice(3)),c.NextId--,f;case "?":return new c.Variable(a.slice(1))}throw"Can't convert from NT: "+a;};a.prototype.sameTerm=function(a){return a?this.hashString()===a.hashString():!1};a.prototype.each=function(a,b,c,d){var g,k;g=[];k=this.statementsMatching(a,b,c,d,!1);if(null==a)for(b=0,c=k.length;b<
c;b++)a=k[b],g.push(a.subject);else if(null==b)for(b=0,c=k.length;b<c;b++)a=k[b],g.push(a.predicate);else if(null==c)for(b=0,c=k.length;b<c;b++)a=k[b],g.push(a.object);else if(null==d)for(b=0,c=k.length;b<c;b++)a=k[b],g.push(a.why);return g};a.prototype.any=function(a,b,c,d){d=this.anyStatementMatching(a,b,c,d);if(null!=d){if(null==a)return d.subject;if(null==b)return d.predicate;if(null==c)return d.object}};a.prototype.holds=function(a,b,c,d){return null!=this.anyStatementMatching(a,b,c,d)};a.prototype.holdsStatement=
function(a){return this.holds(a.subject,a.predicate,a.object,a.why)};a.prototype.the=function(a,b,h,d){d=this.any(a,b,h,d);null==d&&c.log.error("No value found for the() {"+a+" "+b+" "+h+"}.");return d};a.prototype.whether=function(a,b,c,d){return this.statementsMatching(a,b,c,d,!1).length};a.prototype.transitiveClosure=function(a,b,c){var d,g,k,l,m,p;g={};d={};for(l in a)H.call(a,l)&&(m=a[l],d[l]=m);for(;;){a:{a=void 0;for(a in d)if(H.call(d,a)){l=a;break a}l=void 0}if(null==l)return g;a=c?this.each(void 0,
b,this.fromNT(l)):this.each(this.fromNT(l),b);m=0;for(p=a.length;m<p;m++)k=a[m],k=k.toNT(),k in g||k in d||(d[k]=d[l]);g[l]=d[l];delete d[l]}};a.prototype.findMembersNT=function(a){var b,c,d,g,k,l,m,p,q;c={};c[a.toNT()]=!0;a={};c=this.transitiveClosure(c,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),!0);for(d in c)if(H.call(c,d)){p=this.statementsMatching(void 0,this.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.fromNT(d));g=0;for(l=p.length;g<l;g++)b=p[g],a[b.subject.toNT()]=
b;p=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#domain"),this.fromNT(d));g=0;for(l=p.length;g<l;g++)for(b=p[g],q=this.statementsMatching(void 0,b),k=0,m=q.length;k<m;k++)b=q[k],a[b.subject.toNT()]=b;p=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#range"),this.fromNT(d));g=0;for(l=p.length;g<l;g++)for(b=p[g],q=this.statementsMatching(void 0,b),m=0,k=q.length;m<k;m++)b=q[m],a[b.object.toNT()]=b}return a};a.prototype.NTtoURI=function(a){var b,c,d;c={};for(b in a)H.call(a,
b)&&(d=a[b],"<"===b[0]&&(c[b.slice(1,-1)]=d));return c};a.prototype.findTypeURIs=function(a){return this.NTtoURI(this.findTypesNT(a))};a.prototype.findMemberURIs=function(a){return this.NTtoURI(this.findMembersNT(a))};a.prototype.findTypesNT=function(a){var b,c,d,g,k,l,m,p,q;d=[];p=this.statementsMatching(a,void 0,void 0);g=0;for(l=p.length;g<l;g++)if(c=p[g],"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"===c.predicate.uri)d[c.object.toNT()]=c;else for(q=this.each(c.predicate,this.sym("http://www.w3.org/2000/01/rdf-schema#domain")),
k=0,m=q.length;k<m;k++)b=q[k],d[b.toNT()]=c;m=this.statementsMatching(void 0,void 0,a);b=0;for(k=m.length;b<k;b++)for(c=m[b],p=this.each(c.predicate,this.sym("http://www.w3.org/2000/01/rdf-schema#range")),g=0,l=p.length;g<l;g++)a=p[g],d[a.toNT()]=c;return this.transitiveClosure(d,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),!1)};a.prototype.findSuperClassesNT=function(a){var b;b=[];b[a.toNT()]=!0;return this.transitiveClosure(b,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),
!1)};a.prototype.findSubClassesNT=function(a){var b;b=[];b[a.toNT()]=!0;return this.transitiveClosure(b,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),!0)};a.prototype.topTypeURIs=function(a){var b,c,d,g,k,l,m,p;g=[];for(c in a)if(H.call(a,c)){k=a[c];d=0;p=this.each(this.sym(c),this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"));l=0;for(m=p.length;l<m;l++)if(b=p[l],"http://www.w3.org/2000/01/rdf-schema#Resource"!==b.uri){d++;break}d||(g[c]=k)}g["http://www.w3.org/2000/01/rdf-schema#Resource"]&&
delete g["http://www.w3.org/2000/01/rdf-schema#Resource"];g["http://www.w3.org/2002/07/owl#Thing"]&&delete g["http://www.w3.org/2002/07/owl#Thing"];return g};a.prototype.bottomTypeURIs=function(a){var b,c,d,g,k,l,m,p,q;b=[];for(g in a)if(H.call(a,g)){l=a[g];k=this.each(void 0,this.sym("http://www.w3.org/2000/01/rdf-schema#subClassOf"),this.sym(g));c=!0;m=0;for(p=k.length;m<p;m++)if(d=k[m],q=d.uri,0<=Y.call(a,q)){c=!1;break}c&&(b[g]=l)}return b};a.prototype.serialize=function(a,b,h){var d;d=c.Serializer(this);
d.suggestNamespaces(this.namespaces);d.setBase(a);a=h?this.statementsMatching(void 0,void 0,void 0,h):this.statements;switch(null!=b?b:"text/n3"){case "application/rdf+xml":b=d.statementsToXML(a);break;case "text/n3":case "text/turtle":b=d.statementsToN3(a);break;default:throw"serialize: Content-type "+b(NaN);}return b};return a}(c.Node);c.sym=function(b){return new c.Symbol(b)};c.lit=c.Formula.prototype.literal;c.Namespace=c.Formula.prototype.ns;c.variable=c.Formula.prototype.variable;c.Variable=
function(b){function a(a){this.base="varid:";this.uri=c.Util.uri.join(a,this.base)}K(a,b);a.prototype.termType="variable";a.prototype.toNT=function(){return this.uri.slice(0,this.base.length)===this.base?"?"+this.uri.slice(this.base.length):"?"+this.uri};a.prototype.toString=a.prototype.toNT;a.prototype.hashString=a.prototype.toNT;a.prototype.substitute=function(a){var b;return null!=(b=a[this.toNT()])?b:this};a.prototype.sameTerm=function(a){a||!1;return this.termType===a.termType&&this.uri===a.uri};
return a}(c.Node);c.Literal.prototype.classOrder=1;c.Collection.prototype.classOrder=3;c.Formula.prototype.classOrder=4;c.Symbol.prototype.classOrder=5;c.BlankNode.prototype.classOrder=6;c.Variable.prototype.classOrder=7;c.fromNT=c.Formula.prototype.fromNT;c.graph=function(){return new c.IndexedFormula};if(null!=("undefined"!==typeof module&&null!==module?module.exports:void 0))for(C in c)H.call(c,C)&&(N=c[C],module.exports[C]=N);c.RDFParser=function(b){this.frameFactory=function(a,b,f){return{NODE:1,
ARC:2,parent:b,parser:a,store:a.store,element:f,lastChild:0,base:null,lang:null,node:null,nodeType:null,listIndex:1,rdfid:null,datatype:null,collection:!1,terminateFrame:function(){this.collection&&this.node.close()},addSymbol:function(a,b){b=c.Util.uri.join(b,this.base);this.node=this.store.sym(b);this.nodeType=a},loadTriple:function(){this.parent.parent.collection?this.parent.parent.node.append(this.node):this.store.add(this.parent.parent.node,this.parent.node,this.node,this.parser.why);if(null!=
this.parent.rdfid){var a=this.store.sym(c.Util.uri.join("#"+this.parent.rdfid,this.base));this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#Statement"),this.parser.why);this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#subject"),this.parent.parent.node,this.parser.why);this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#predicate"),this.parent.node,this.parser.why);
this.store.add(a,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#object"),this.node,this.parser.why)}},isTripleToLoad:function(){return null!=this.parent&&null!=this.parent.parent&&this.nodeType===this.NODE&&this.parent.nodeType===this.ARC&&this.parent.parent.nodeType===this.NODE},addNode:function(a){this.addSymbol(this.NODE,a);this.isTripleToLoad()&&this.loadTriple()},addCollection:function(){this.nodeType=this.NODE;this.node=this.store.collection();this.collection=!0;this.isTripleToLoad()&&
this.loadTriple()},addCollectionArc:function(){this.nodeType=this.ARC},addBNode:function(a){this.node=null!=a?null!=this.parser.bnodes[a]?this.parser.bnodes[a]:this.parser.bnodes[a]=this.store.bnode():this.store.bnode();this.nodeType=this.NODE;this.isTripleToLoad()&&this.loadTriple()},addArc:function(a){"http://www.w3.org/1999/02/22-rdf-syntax-ns#li"===a&&(a="http://www.w3.org/1999/02/22-rdf-syntax-ns#_"+this.parent.listIndex,this.parent.listIndex++);this.addSymbol(this.ARC,a)},addLiteral:function(a){this.node=
this.parent.datatype?this.store.literal(a,"",this.store.sym(this.parent.datatype)):this.store.literal(a,this.lang);this.nodeType=this.NODE;this.isTripleToLoad()&&this.loadTriple()}}};this.getAttributeNodeNS=function(a,b,c){var h=null;if(a.getAttributeNodeNS)h=a.getAttributeNodeNS(b,c);else{a=a.attributes;for(var d,g,k=0;k<a.length;++k)if(d=a[k],d.namespaceURI===b&&(g=d.prefix?d.prefix+":"+c:c,g===d.nodeName)){h=d;break}}return h};this.store=b;this.bnodes={};this.why=null;this.reify=!1;this.parse=
function(a,b,c){var h=a.childNodes;this.cleanParser();var d;if(9===a.nodeType)for(a=0;a<h.length;a++){if(1===h[a].nodeType){d=h[a];break}}else if(1===a.nodeType)d=a;else throw Error("RDFParser: can't find root in "+b+". Halting. ");this.why=c;c=this.frameFactory(this);this.base=b;c.base=b;c.lang="";this.parseDOM(this.buildFrame(c,d));return!0};this.parseDOM=function(a){for(var b,f=function(a){var b="";if(null==a.namespaceURI)throw Error("RDF/XML syntax error: No namespace for "+a.localName+" in "+
this.base);a.namespaceURI&&(b+=a.namespaceURI);a.localName?b+=a.localName:a.nodeName&&(b=0<=a.nodeName.indexOf(":")?b+a.nodeName.split(":")[1]:b+a.nodeName);return b}.bind(this),h=!0;a.parent;){var d=a.element,g=d.attributes;if(3===d.nodeType||4===d.nodeType)a.parent.nodeType==a.NODE&&(a.addArc("http://www.w3.org/1999/02/22-rdf-syntax-ns#value"),a=this.buildFrame(a)),a.addLiteral(d.nodeValue);else if("http://www.w3.org/1999/02/22-rdf-syntax-ns#RDF"!==f(d))if(a.parent&&a.parent.collection&&(a.addCollectionArc(),
a=this.buildFrame(a,a.element),a.parent.element=null),a.parent&&a.parent.nodeType&&a.parent.nodeType!==a.ARC){a.addArc(f(d));this.reify&&(b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","ID"))&&(a.rdfid=b.nodeValue,d.removeAttributeNode(b));b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","parseType");var k=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","datatype");k&&(a.datatype=k.nodeValue,d.removeAttributeNode(k));b&&(k=
b.nodeValue,"Literal"===k?(a.datatype="http://www.w3.org/1999/02/22-rdf-syntax-ns#XMLLiteral",a=this.buildFrame(a),a.addLiteral(d),h=!1):"Resource"===k?(a=this.buildFrame(a,a.element),a.parent.element=null,a.addBNode()):"Collection"===k&&(a=this.buildFrame(a,a.element),a.parent.element=null,a.addCollection()),d.removeAttributeNode(b));if(0!==g.length)for(b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","resource"),k=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#",
"nodeID"),a=this.buildFrame(a),b?(a.addNode(b.nodeValue),d.removeAttributeNode(b)):k?(a.addBNode(k.nodeValue),d.removeAttributeNode(k)):a.addBNode(),d=g.length-1;0<=d;d--)b=this.buildFrame(a),b.addArc(f(g[d])),"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"===f(g[d])?this.buildFrame(b).addNode(g[d].nodeValue):this.buildFrame(b).addLiteral(g[d].nodeValue);else 0===d.childNodes.length&&this.buildFrame(a).addLiteral("")}else{k=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#",
"about");b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","ID");if(k&&b)throw Error("RDFParser: "+d.nodeName+" has both rdf:id and rdf:about. Halting. Only one of these properties may be specified on a node.");!k&&b?(a.addNode("#"+b.nodeValue),d.removeAttributeNode(b)):null==k&&null==b?(b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","nodeID"))?(a.addBNode(b.nodeValue),d.removeAttributeNode(b)):a.addBNode():(a.addNode(k.nodeValue),d.removeAttributeNode(k));
b=this.getAttributeNodeNS(d,"http://www.w3.org/1999/02/22-rdf-syntax-ns#","type");"http://www.w3.org/1999/02/22-rdf-syntax-ns#Description"!==f(d)&&(b={nodeValue:f(d)});null!=b&&(this.store.add(a.node,this.store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),this.store.sym(c.Util.uri.join(b.nodeValue,a.base)),this.why),b.nodeName&&d.removeAttributeNode(b));for(d=g.length-1;0<=d;d--)this.store.add(a.node,this.store.sym(f(g[d])),this.store.literal(g[d].nodeValue,a.lang),this.why)}for(d=a.element;a.parent;){for(g=
a;null==d;)a=a.parent,d=a.element;if((b=d.childNodes&&d.childNodes[a.lastChild])&&h)if(1!==b.nodeType&&3!==b.nodeType&&4!==b.nodeType||(3===b.nodeType||4===b.nodeType)&&1!==d.childNodes.length)a.lastChild++;else{a.lastChild++;a=this.buildFrame(g,d.childNodes[a.lastChild-1]);break}else{a.terminateFrame();if(!(a=a.parent))break;d=a.element;h=!0}}}};this.cleanParser=function(){this.bnodes={};this.why=null};this.buildFrame=function(a,b){var f=this.frameFactory(this,a,b);a&&(f.base=a.base,f.lang=a.lang);
if(!b||3===b.nodeType||4===b.nodeType)return f;var h=b.attributes,d=b.getAttributeNode("xml:base");null!=d&&(f.base=d.nodeValue,b.removeAttribute("xml:base"));d=b.getAttributeNode("xml:lang");null!=d&&(f.lang=d.nodeValue,b.removeAttribute("xml:lang"));for(d=h.length-1;0<=d;d--)if("xml"===h[d].nodeName.substr(0,3)){if("xmlns:"===h[d].name.slice(0,6)){var g=h[d].nodeValue;this.base&&(g=c.Util.uri.join(g,this.base));this.store.setPrefixForURI(h[d].name.slice(6),g)}b.removeAttributeNode(h[d])}return f}};
c.N3Parser=function(){function b(a,b,c,g,e,f,k,l){"undefined"==typeof b&&(b=null);"undefined"==typeof c&&(c="");"undefined"==typeof g&&(g=null);"undefined"==typeof e&&(e="");"undefined"==typeof k&&(k="");"undefined"==typeof l&&(l=null);this._bindings=new d([]);this._flags=k;""!=c&&(m(0<=c.indexOf(":"),"Document URI not absolute: "+c),this._bindings[""]=c+"#");this._store=a;e&&a.setGenPrefix(e);this._thisDoc=c;this.source=a.sym(c);this.previousLine=this.startOfLine=this.statementCount=this.lines=0;
this._genPrefix=e;this.keywords=new h("a this bind has is of true false".split(" "));this.keywordsSet=0;this._anonymousNodes=new d([]);this._variables=new d([]);this._parentVariables=new d([]);this._reason=l;this._reason2=null;this._baseURI=g?g:c?c:null;m(!this._baseURI||0<=this._baseURI.indexOf(":"));this._genPrefix||(this._genPrefix=this._thisDoc?this._thisDoc+"#_g":RDFSink_uniqueURI());this._context=this._formula=null==b?this._thisDoc?a.formula(c+"#_formula"):a.formula():b;this._parentContext=
null}function a(a,b,c,n,e){return"Line "+(b+1)+" of <"+a+">: Bad syntax: "+e+'\nat: "'+g(c,n,n+30)+'"'}var e={encode:function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var g=a.charCodeAt(c);128>g?b+=String.fromCharCode(g):(127<g&&2048>g?b+=String.fromCharCode(g>>6|192):(b+=String.fromCharCode(g>>12|224),b+=String.fromCharCode(g>>6&63|128)),b+=String.fromCharCode(g&63|128))}return b},decode:function(a){for(var b="",c=0;c<a.length;){var g=a.charCodeAt(c);128>g?(b+=String.fromCharCode(g),
c++):191<g&&224>g?(b+=String.fromCharCode((g&31)<<6|a.charCodeAt(c+1)&63),c+=2):(b+=String.fromCharCode((g&15)<<12|(a.charCodeAt(c+1)&63)<<6|a.charCodeAt(c+2)&63),c+=3)}return b}},f=function(a){return a},h=function(a){return a},d=function(a){if(0<a.length)throw"missing.js: oops nnonempty dict not imp";return[]},g=function(a,b,c){if("undefined"==typeof a.slice)throw"@@ mising.js: No .slice function for "+a+" of type "+typeof a;return"undefined"==typeof c||null==c?a.slice(b):a.slice(b,c)},k=Error("dummy error stop iteration"),
l=function(a){this.last=0;this.li=a;this.next=function(){if(this.last==this.li.length)throw k;return this.li[this.last++]};return this},m=function(a,b){if(!a){if(b)throw"python Assertion failed: "+b;throw"(python) Assertion failed.";}};String.prototype.encode=function(a){if("utf-8"!=a)throw"UTF8_converter: can only do utf-8";return e.encode(this)};String.prototype.decode=function(a){if("utf-8"!=a)throw"UTF8_converter: can only do utf-8";return this};var p=RegExp("^([-+]?[0-9]+)(\\.[0-9]+)?(e[-+]?[0-9]+)?",
"g"),q=/^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9](T[0-9][0-9]:[0-9][0-9](:[0-9][0-9](\.[0-9]*)?)?)?Z?/,t=RegExp('[\\\\\\r\\n\\"]',"g"),w=RegExp("^[a-zA-Z0-9]+(-[a-zA-Z0-9]+)?","g");b.prototype.here=function(a){return this._genPrefix+"_L"+this.lines+"C"+(a-this.startOfLine+1)};b.prototype.formula=function(){return this._formula};b.prototype.loadStream=function(a){return this.loadBuf(a.read())};b.prototype.loadBuf=function(a){this.startDoc();this.feed(a);return this.endDoc()};b.prototype.feed=function(b){b=
b.decode("utf-8");for(var c=0;0<=c;){var g=this.skipSpace(b,c);if(0>g)break;c=this.directiveOrStatement(b,g);if(0>c)throw a(this._thisDoc,this.lines,b,g,"expected directive or statement");}};b.prototype.directiveOrStatement=function(a,b){var c=this.skipSpace(a,b);if(0>c)return c;var g=this.directive(a,c);if(0<=g)return this.checkDot(a,g);g=this.statement(a,c);return 0<=g?this.checkDot(a,g):g};b.prototype.tok=function(a,b,e){if("@"==g(b,e,e+1))e+=1;else if(0>c.Util.ArrayIndexOf(this.keywords,a))return-1;
var f=e+a.length;return g(b,e,f)==a&&0<="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~".indexOf(b.charAt(f))?f:-1};b.prototype.directive=function(b,e){var f=this.skipSpace(b,e);if(0>f)return f;var n=new h([]),f=this.tok("bind",b,e);if(0<f)throw a(this._thisDoc,this.lines,b,e,"keyword bind is obsolete: use @prefix");f=this.tok("keywords",b,e);if(0<f){e=this.commaSeparatedList(b,f,n,!1);if(0>e)throw a(this._thisDoc,this.lines,b,e,"'@keywords' needs comma separated list of words");this.setKeywords(g(n,null,
null));return e}f=this.tok("forAll",b,e);if(0<f){e=this.commaSeparatedList(b,f,n,!0);if(0>e)throw a(this._thisDoc,this.lines,b,e,"Bad variable list after @forAll");f=new l(n);try{for(;;){var d=f.next();if(0>c.Util.ArrayIndexOf(this._variables,d)||0<=c.Util.ArrayIndexOf(this._parentVariables,d))this._variables[d]=this._context.newUniversal(d)}}catch(M){if(M!=k)throw M;}return e}f=this.tok("forSome",b,e);if(0<f){e=this.commaSeparatedList(b,f,n,this.uri_ref2);if(0>e)throw a(this._thisDoc,this.lines,
b,e,"Bad variable list after @forSome");f=new l(n);try{for(;;)d=f.next(),this._context.declareExistential(d)}catch(p){if(p!=k)throw p;}return e}f=this.tok("prefix",b,e);if(0<=f){d=new h([]);e=this.qname(b,f,d);if(0>e)throw a(this._thisDoc,this.lines,b,f,"expected qname after @prefix");f=this.uri_ref2(b,e,d);if(0>f)throw a(this._thisDoc,this.lines,b,e,"expected <uriref> after @prefix _qname_");n=d[1].uri;this._baseURI?n=c.Util.uri.join(n,this._baseURI):m(0<=n.indexOf(":"),"With no base URI, cannot handle relative URI for NS");
m(0<=n.indexOf(":"));this._bindings[d[0][0]]=n;this.bind(d[0][0],encodeURI(n));return f}f=this.tok("base",b,e);if(0<=f){d=new h([]);e=this.uri_ref2(b,f,d);if(0>e)throw a(this._thisDoc,this.lines,b,f,"expected <uri> after @base ");n=d[0].uri;if(this._baseURI)n=c.Util.uri.join(n,this._baseURI);else throw a(this._thisDoc,this.lines,b,f,"With no previous base URI, cannot use relative URI in @base  <"+n+">");m(0<=n.indexOf(":"));this._baseURI=n;return e}return-1};b.prototype.bind=function(a,b){""!=a&&
this._store.setPrefixForURI(a,b)};b.prototype.setKeywords=function(a){null==a?this.keywordsSet=0:(this.keywords=a,this.keywordsSet=1)};b.prototype.startDoc=function(){};b.prototype.endDoc=function(){return this._formula};b.prototype.makeStatement=function(a){a[0].add(a[2],a[1],a[3],this.source);this.statementCount+=1};b.prototype.statement=function(b,c){var g=new h([]);c=this.object(b,c,g);if(0>c)return c;g=this.property_list(b,c,g[0]);if(0>g)throw a(this._thisDoc,this.lines,b,c,"expected propertylist");
return g};b.prototype.subject=function(a,b,c){return this.item(a,b,c)};b.prototype.verb=function(b,c,e){var d=this.skipSpace(b,c);if(0>d)return d;var k=new h([]),d=this.tok("has",b,c);if(0<=d){c=this.prop(b,d,k);if(0>c)throw a(this._thisDoc,this.lines,b,d,"expected property after 'has'");e.push(new f(["->",k[0]]));return c}d=this.tok("is",b,c);if(0<=d){c=this.prop(b,d,k);if(0>c)throw a(this._thisDoc,this.lines,b,d,"expected <property> after 'is'");d=this.skipSpace(b,c);if(0>d)throw a(this._thisDoc,
this.lines,b,c,"End of file found, expected property after 'is'");c=d;d=this.tok("of",b,c);if(0>d)throw a(this._thisDoc,this.lines,b,c,"expected 'of' after 'is' <prop>");e.push(new f(["<-",k[0]]));return d}d=this.tok("a",b,c);if(0<=d)return e.push(new f(["->",this._store.sym("http://www.w3.org/1999/02/22-rdf-syntax-ns#type")])),d;if("<="==g(b,c,c+2))return e.push(new f(["<-",this._store.sym("http://www.w3.org/2000/10/swap/log#implies")])),c+2;if("="==g(b,c,c+1)){if(">"==g(b,c+1,c+2))return e.push(new f(["->",
this._store.sym("http://www.w3.org/2000/10/swap/log#implies")])),c+2;e.push(new f(["->",this._store.sym("http://www.w3.org/2002/07/owl#sameAs")]));return c+1}if(":="==g(b,c,c+2))return e.push(new f(["->","http://www.w3.org/2000/10/swap/log#becomes"])),c+2;d=this.prop(b,c,k);if(0<=d)return e.push(new f(["->",k[0]])),d;if(">-"==g(b,c,c+2)||"<-"==g(b,c,c+2))throw a(this._thisDoc,this.lines,b,d,">- ... -> syntax is obsolete.");return-1};b.prototype.prop=function(a,b,c){return this.item(a,b,c)};b.prototype.item=
function(a,b,c){return this.path(a,b,c)};b.prototype.blankNode=function(a){return this._context.bnode(a,this._reason2)};b.prototype.path=function(b,c,e){c=this.nodeOrLiteral(b,c,e);if(0>c)return c;for(;0<="!^.".indexOf(g(b,c,c+1));){var d=g(b,c,c+1);if("."==d){var k=g(b,c+1,c+2);if(!k||0<="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(k)&&0>":?<[{(".indexOf(k))break}var k=e.pop(),h=this.blankNode(this.here(c));c=this.node(b,c+1,e);if(0>c)throw a(this._thisDoc,this.lines,b,c,"EOF found in middle of path syntax");
var l=e.pop();"^"==d?this.makeStatement(new f([this._context,l,h,k])):this.makeStatement(new f([this._context,l,k,h]));e.push(h)}return c};b.prototype.anonymousNode=function(a){var b=this._anonymousNodes[a];if(b)return b;b=this._store.bnode(this._context,this._reason2);return this._anonymousNodes[a]=b};b.prototype.node=function(b,c,e,n){"undefined"==typeof n&&(n=null);var u=n;n=this.skipSpace(b,c);if(0>n)return n;c=n;n=g(b,c,c+1);if("["==n){var m=this.here(c);n=this.skipSpace(b,c+1);if(0>n)throw a(this._thisDoc,
this.lines,b,c,"EOF after '['");if("="==g(b,n,n+1)){c=n+1;var p=new h([]);n=this.objectList(b,c,p);if(0<=n){u=p[0];if(1<p.length){p=new l(p);try{for(;;){var q=p.next();this.makeStatement(new f([this._context,this._store.sym("http://www.w3.org/2002/07/owl#sameAs"),u,q]))}}catch(t){if(t!=k)throw t;}}n=this.skipSpace(b,n);if(0>n)throw a(this._thisDoc,this.lines,b,c,"EOF when objectList expected after [ = ");";"==g(b,n,n+1)&&(n+=1)}else throw a(this._thisDoc,this.lines,b,c,"objectList expected after [= ");
}null==u&&(u=this.blankNode(m));c=this.property_list(b,n,u);if(0>c)throw a(this._thisDoc,this.lines,b,n,"property_list expected");n=this.skipSpace(b,c);if(0>n)throw a(this._thisDoc,this.lines,b,c,"EOF when ']' expected after [ <propertyList>");if("]"!=g(b,n,n+1))throw a(this._thisDoc,this.lines,b,n,"']' expected");e.push(u);return n+1}if("{"==n){n=g(b,c+1,c+2);if("$"==n){n=c+1+1;u=new h([]);for(m=!0;;){c=this.skipSpace(b,n);if(0>c)throw a(this._thisDoc,this.lines,b,c,"needed '$}', found end.");if("$}"==
g(b,c,c+2)){n=c+2;break}if(m)m=!1;else if(","==g(b,c,c+1))c+=1;else throw a(this._thisDoc,this.lines,b,c,"expected: ','");q=new h([]);n=this.item(b,c,q);if(0>n)throw a(this._thisDoc,this.lines,b,c,"expected item in set or '$}'");u.push(q[0])}e.push(this._store.newSet(u,this._context))}else{n=c+1;q=this._parentContext;this._parentContext=this._context;m=this._anonymousNodes;p=this._parentVariables;this._parentVariables=this._variables;this._anonymousNodes=new d([]);this._variables=this._variables.slice();
var S=this._reason2;this._reason2=null;null==u&&(u=this._store.formula());for(this._context=u;;){c=this.skipSpace(b,n);if(0>c)throw a(this._thisDoc,this.lines,b,c,"needed '}', found end.");if("}"==g(b,c,c+1)){n=c+1;break}n=this.directiveOrStatement(b,c);if(0>n)throw a(this._thisDoc,this.lines,b,c,"expected statement or '}'");}this._anonymousNodes=m;this._variables=this._parentVariables;this._parentVariables=p;this._context=this._parentContext;this._reason2=S;this._parentContext=q;e.push(u.close())}return n}if("("==
n){m=this._store.list;n=g(b,c+1,c+2);"$"==n&&(m=this._store.newSet,c+=1);n=c+1;for(u=new h([]);;){c=this.skipSpace(b,n);if(0>c)throw a(this._thisDoc,this.lines,b,c,"needed ')', found end.");if(")"==g(b,c,c+1)){n=c+1;break}q=new h([]);n=this.item(b,c,q);if(0>n)throw a(this._thisDoc,this.lines,b,c,"expected item in list or ')'");u.push(q[0])}e.push(m(u,this._context));return n}n=this.tok("this",b,c);if(0<=n)throw a(this._thisDoc,this.lines,b,c,"Keyword 'this' was ancient N3. Now use @forSome and @forAll keywords.");
n=this.tok("true",b,c);if(0<=n)return e.push(!0),n;n=this.tok("false",b,c);return 0<=n?(e.push(!1),n):null==u&&(n=this.uri_ref2(b,c,e),0<=n)?n:-1};b.prototype.property_list=function(b,c,e){for(;;){var d=this.skipSpace(b,c);if(0>d)throw a(this._thisDoc,this.lines,b,c,"EOF found when expected verb in property list");if(":-"==g(b,d,d+2)){c=d+2;var u=new h([]),d=this.node(b,c,u,e);if(0>d)throw a(this._thisDoc,this.lines,b,c,"bad {} or () or [] node after :- ");c=d}else{c=d;u=new h([]);d=this.verb(b,c,
u);if(0>=d)return c;var m=new h([]);c=this.objectList(b,d,m);if(0>c)throw a(this._thisDoc,this.lines,b,d,"objectList expected");d=new l(m);try{for(;;){var p=d.next(),q=u[0],t=q[1];"->"==q[0]?this.makeStatement(new f([this._context,t,e,p])):this.makeStatement(new f([this._context,t,p,e]))}}catch(S){if(S!=k)throw S;}d=this.skipSpace(b,c);if(0>d)throw a(this._thisDoc,this.lines,b,d,"EOF found in list of objects");if(";"!=g(b,c,c+1))return c;c+=1}}};b.prototype.commaSeparatedList=function(b,c,e,d){var f=
this.skipSpace(b,c);if(0>f)throw a(this._thisDoc,this.lines,b,f,"EOF found expecting comma sep list");if("."==b.charAt(f))return c;f=d?this.uri_ref2(b,f,e):this.bareWord(b,f,e);if(0>f)return-1;for(;;){c=this.skipSpace(b,f);if(0>c)return c;f=g(b,c,c+1);if(","!=f)return"."!=f?-1:c;f=d?this.uri_ref2(b,c+1,e):this.bareWord(b,c+1,e);if(0>f)throw a(this._thisDoc,this.lines,b,f,"bad list content");}};b.prototype.objectList=function(b,c,e){c=this.object(b,c,e);if(0>c)return-1;for(;;){c=this.skipSpace(b,c);
if(0>c)throw a(this._thisDoc,this.lines,b,c,"EOF found after object");if(","!=g(b,c,c+1))return c;c=this.object(b,c+1,e);if(0>c)return c}};b.prototype.checkDot=function(b,c){var e=this.skipSpace(b,c);if(0>e)return e;if("."==g(b,e,e+1))return e+1;if("}"==g(b,e,e+1)||"]"==g(b,e,e+1))return e;throw a(this._thisDoc,this.lines,b,e,"expected '.' or '}' or ']' at end of statement");};b.prototype.uri_ref2=function(b,e,f){var d=new h([]),k=this.qname(b,e,d);if(0<=k){var l=d[0],d=l[0],l=l[1];if(null==d){m(0,
"not used?");var p=this._baseURI+"#"}else if(p=this._bindings[d],!p){if("_"==d)return f.push(this.anonymousNode(l)),k;throw a(this._thisDoc,this.lines,b,e,"Prefix "+d+" not bound.");}b=this._store.sym(p+l);0<=c.Util.ArrayIndexOf(this._variables,b)?f.push(this._variables[b]):f.push(b);return k}e=this.skipSpace(b,e);if(0>e)return-1;if("?"==b.charAt(e))return d=new h([]),k=this.variable(b,e,d),0<k?(f.push(d[0]),k):-1;if("<"==b.charAt(e)){for(d=e+=1;e<b.length;){if(">"==b.charAt(e))return k=g(b,d,e),
this._baseURI?k=c.Util.uri.join(k,this._baseURI):m(0<=k.indexOf(":"),"With no base URI, cannot deal with relative URIs"),"#"==g(b,e-1,e)&&"#"!=g(k,-1,null)&&(k+="#"),b=this._store.sym(k),0<=c.Util.ArrayIndexOf(this._variables,b)?f.push(this._variables[b]):f.push(b),e+1;e+=1}throw a(this._thisDoc,this.lines,b,k,"unterminated URI reference");}if(this.keywordsSet){d=new h([]);k=this.bareWord(b,e,d);if(0>k)return-1;if(0<=c.Util.ArrayIndexOf(this.keywords,d[0]))throw a(this._thisDoc,this.lines,b,e,'Keyword "'+
d[0]+'" not allowed here.');f.push(this._store.sym(this._bindings[""]+d[0]));return k}return-1};b.prototype.skipSpace=function(a,b){for(var c=b?b:0;c<a.length;c++){var e=a.charAt(c);if(0>" \n\r\t\f\x0B\u00a0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000".indexOf(e))if("#"===a.charAt(c))for(;;c++){if(c===a.length)return-1;if("\n"===a.charAt(c)){this.lines+=1;break}}else return c;else"\n"===a.charAt(c)&&(this.lines+=1)}return-1};b.prototype.variable=function(b,
c,e){var d=this.skipSpace(b,c);if(0>d||"?"!=g(b,d,d+1))return-1;c=d+=1;if(0<="0123456789-".indexOf(b.charAt(d)))throw a(this._thisDoc,this.lines,b,d,"Varible name can't start with '"+b.charAt(d)+"s'");for(;c<b.length&&0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(b.charAt(c));)c+=1;if(null==this._parentContext)throw a(this._thisDoc,this.lines,b,d,"Can't use ?xxx syntax for variable in outermost level: "+g(b,d-1,c));e.push(this._store.variable(g(b,d,c)));return c};b.prototype.bareWord=function(a,
b,c){var e=this.skipSpace(a,b);if(0>e)return-1;b=a.charAt(e);if(0<="0123456789-".indexOf(b)||0<="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(b))return-1;for(b=e;b<a.length&&0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(a.charAt(b));)b+=1;c.push(g(a,e,b));return b};b.prototype.qname=function(a,b,e){b=this.skipSpace(a,b);if(0>b)return-1;var g=a.charAt(b);if(0<="0123456789-+".indexOf(g))return-1;if(0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(g)){var d=g;for(b+=1;b<a.length;)if(g=a.charAt(b),
0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(g))d+=g,b+=1;else break}else d="";if(b<a.length&&":"==a.charAt(b)){var k=d;b+=1;for(d="";b<a.length;)if(g=a.charAt(b),0>"\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~:".indexOf(g))d+=g,b+=1;else break;e.push(new f([k,d]));return b}return d&&this.keywordsSet&&0>c.Util.ArrayIndexOf(this.keywords,d)?(e.push(new f(["",d])),b):-1};b.prototype.object=function(a,b,c){var e=this.subject(a,b,c);if(0<=e)return e;e=this.skipSpace(a,b);if(0>e)return-1;b=e;return'"'==
a.charAt(b)?(e='"""'==g(a,b,b+3)?'"""':'"',b+=e.length,a=this.strconst(a,b,e),e=a[0],c.push(this._store.literal(a[1])),e):-1};b.prototype.nodeOrLiteral=function(b,c,e){var d=this.node(b,c,e);if(0<=d)return d;d=this.skipSpace(b,c);if(0>d)return-1;c=d;d=b.charAt(c);if(0<="-+0987654321".indexOf(d)){q.lastIndex=0;var f=q.exec(b.slice(c));if(null!=f){var k=f[0],d=c+k.length;0<=k.indexOf("T")?e.push(this._store.literal(k,void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#dateTime"))):e.push(this._store.literal(k,
void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#date")))}else{p.lastIndex=0;f=p.exec(b.slice(c));if(null==f)throw a(this._thisDoc,this.lines,b,c,"Bad number or date syntax");d=c+p.lastIndex;k=g(b,c,d);0<=k.indexOf("e")?e.push(this._store.literal(parseFloat(k),void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#double"))):0<=g(b,c,d).indexOf(".")?e.push(this._store.literal(parseFloat(k),void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#decimal"))):e.push(this._store.literal(parseInt(k),
void 0,this._store.sym("http://www.w3.org/2001/XMLSchema#integer")))}return d}if('"'==b.charAt(c)){d='"""'==g(b,c,c+3)?'"""':'"';c+=d.length;var k=null,l=this.strconst(b,c,d),d=l[0],l=l[1],f=null;if("@"==g(b,d,d+1)){w.lastIndex=0;f=w.exec(b.slice(d+1));if(null==f)throw a(this._thisDoc,startline,b,c,"Bad language code syntax on string literal, after @");c=w.lastIndex+d+1;f=g(b,d+1,c);d=c}"^^"==g(b,d,d+2)&&(c=new h([]),d=this.uri_ref2(b,d+2,c),k=c[0]);e.push(this._store.literal(l,f,k));return d}return-1};
b.prototype.strconst=function(b,c,e){for(var d=c,k="",h=this.lines;d<b.length;){c=d+e.length;if(g(b,d,c)==e)return new f([c,k]);if('"'==b.charAt(d))k+='"',d+=1;else{t.lastIndex=0;if(!t.exec(b.slice(d)))throw a(this._thisDoc,h,b,d,"Closing quote missing in string at ^ in "+g(b,d-20,d)+"^"+g(b,d,d+20));c=d+t.lastIndex-1;var k=k+g(b,d,c),l=b.charAt(c);if('"'==l)d=c;else if("\r"==l)d=c+1;else if("\n"==l){if('"'==e)throw a(this._thisDoc,h,b,c,"newline found in string literal");this.lines+=1;k+=l;d=c+1;
this.previousLine=this.startOfLine;this.startOfLine=d}else if("\\"==l){d=c+1;l=g(b,d,d+1);if(!l)throw a(this._thisDoc,h,b,c,"unterminated string literal (2)");var m='abfrtvn\\"'.indexOf(l);if(0<=m)l='a\b\f\r\t\v\n\\"'.charAt(m),k+=l,d+=1;else if("u"==l)l=this.uEscape(b,d+1,h),d=l[0],l=l[1],k+=l;else if("U"==l)l=this.UEscape(b,d+1,h),d=l[0],l=l[1],k+=l;else throw a(this._thisDoc,this.lines,b,c,"bad escape");}}}throw a(this._thisDoc,this.lines,b,c,"unterminated string literal");};b.prototype.uEscape=
function(b,c,e){for(var d=c,k=0,h=0;4>k;){var l=g(b,d,d+1).toLowerCase(),d=d+1;if(""==l)throw a(this._thisDoc,e,b,c,"unterminated string literal(3)");l="0123456789abcdef".indexOf(l);if(0>l)throw a(this._thisDoc,e,b,c,"bad string literal hex escape");h=16*h+l;k+=1}b=String.fromCharCode(h);return new f([d,b])};b.prototype.UEscape=function(b,c,e){for(var d=c,k=0,h="\\U";8>k;){var l=g(b,d,d+1).toLowerCase(),d=d+1;if(""==l)throw a(this._thisDoc,e,b,c,"unterminated string literal(3)");if(0>"0123456789abcdef".indexOf(l))throw a(this._thisDoc,
e,b,c,"bad string literal hex escape");h+=l;k+=1}b="0x"+g(h,2,10)-0;b=String.fromCharCode(b);return new f([d,b])};return function(a,c,e,d,g,f,k,h){return new b(a,c,e,d,g,f,k,h)}}();c.IndexedFormula=function(){c.Literal.prototype.hashString=c.Literal.prototype.toNT;c.Symbol.prototype.hashString=c.Symbol.prototype.toNT;c.BlankNode.prototype.hashString=c.BlankNode.prototype.toNT;c.Collection.prototype.hashString=c.Collection.prototype.toNT;c.IndexedFormula=function(b){function a(a,b,c,e){c=a.any(void 0,
c,e);if(void 0==c)return!1;a.equate(c,b);return!0}function e(a,b,c,e){b=a.any(b,c,void 0);if(void 0==b)return!1;a.equate(b,e);return!0}this.statements=[];this.optional=[];this.propertyActions=[];this.classActions=[];this.redirections=[];this.aliases=[];this.HTTPRedirects=[];this.subjectIndex=[];this.predicateIndex=[];this.objectIndex=[];this.whyIndex=[];this.index=[this.subjectIndex,this.predicateIndex,this.objectIndex,this.whyIndex];this.namespaces={};void 0===b&&(b=["sameAs","InverseFunctionalProperty",
"FunctionalProperty"]);this.propertyActions["<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>"]=[function(a,b,c,e,k){void 0!=a.typeCallback&&a.typeCallback(a,e,k);var l=a.classActions[e.hashString()],m=!1;if(l)for(var p=0;p<l.length;p++)m=m||l[p](a,b,c,e,k);return m}];0<=c.Util.ArrayIndexOf(b,"sameAs")&&(this.propertyActions["<http://www.w3.org/2002/07/owl#sameAs>"]=[function(a,b,c,e,k){a.equate(b,e);return!0}]);0<=c.Util.ArrayIndexOf(b,"InverseFunctionalProperty")&&(this.classActions["<http://www.w3.org/2002/07/owl#InverseFunctionalProperty>"]=
[function(b,c,e,g,k){return b.newPropertyAction(c,a)}]);0<=c.Util.ArrayIndexOf(b,"FunctionalProperty")&&(this.classActions["<http://www.w3.org/2002/07/owl#FunctionalProperty>"]=[function(a,b,c,g,k){return a.newPropertyAction(b,e)}])};c.IndexedFormula.prototype=new c.Formula;c.IndexedFormula.prototype.constructor=c.IndexedFormula;c.IndexedFormula.SuperClass=c.Formula;c.IndexedFormula.prototype.newPropertyAction=function(b,a){var c=b.hashString();void 0==this.propertyActions[c]&&(this.propertyActions[c]=
[]);this.propertyActions[c].push(a);for(var c=this.statementsMatching(void 0,b,void 0),f=!1,h=0;h<c.length;h++)f=f||a(this,c[h].subject,b,c[h].object);return f};c.IndexedFormula.prototype.setPrefixForURI=function(b,a){"tab"==b&&this.namespaces.tab||"ns"!==b.slice(0,2)&&"default"!==b.slice(0,7)&&(this.namespaces[b]=a)};c.IndexedFormula.prototype.register=function(b,a){this.namespaces[b]=a};c.IndexedFormula.prototype.equate=function(b,a){b=this.canon(b);a=this.canon(a);var c=b.compareTerm(a);return c?
0>c?this.replaceWith(a,b):this.replaceWith(b,a):!0};c.IndexedFormula.prototype.replaceWith=function(b,a){for(var c=b.hashString(),f=a.hashString(),h=function(a){var b=a[c];if(void 0!=b){var d=a[f];a[f]=void 0==d?b:b.concat(d);delete a[c]}},d=0;4>d;d++)h(this.index[d]);this.redirections[c]=a;if(b.uri){void 0==this.aliases[f]&&(this.aliases[f]=[]);this.aliases[f].push(b);if(this.aliases[c])for(d=0;d<this.aliases[c].length;d++)this.redirections[this.aliases[c][d].hashString()]=a,this.aliases[f].push(this.aliases[c][d]);
this.add(a,this.sym("http://www.w3.org/2007/ont/link#uri"),b.uri);this.fetcher&&this.fetcher.nowKnownAs(b,a)}h(this.classActions);h(this.propertyActions);return!0};c.IndexedFormula.prototype.canon=function(b){if(void 0==b)return b;var a=this.redirections[b.hashString()];return void 0==a?b:a};c.IndexedFormula.prototype.sameThings=function(b,a){if(b.sameTerm(a))return!0;var c=this.canon(b);if(void 0==c)return!1;var f=this.canon(a);return void 0==f?!1:c.uri==f.uri};c.IndexedFormula.prototype.uris=function(b){var a=
this.canon(b);b=this.aliases[a.hashString()];if(!a.uri)return[];a=[a.uri];if(void 0!=b)for(var c=0;c<b.length;c++)a.push(b[c].uri);return a};c.IndexedFormula.prototype.add=function(b,a,e,f){var h;void 0==f&&(f=this.fetcher?this.fetcher.appNode:this.sym("chrome:theSession"));b=c.term(b);a=c.term(a);e=c.term(e);f=c.term(f);void 0!=this.predicateCallback&&this.predicateCallback(this,a,f);var d=this.canon(a).hashString();h=this.propertyActions[d];var g=!1;if(h)for(var k=0;k<h.length;k++)g=g||h[k](this,
b,a,e,f);h=[this.canon(b).hashString(),d,this.canon(e).hashString(),this.canon(f).hashString()];b=new c.Statement(b,a,e,f);for(k=0;4>k;k++)a=this.index[k],e=h[k],void 0==a[e]&&(a[e]=[]),a[e].push(b);this.statements.push(b);return b};c.IndexedFormula.prototype.mentionsURI=function(b){b="<"+b+">";return!!this.subjectIndex[b]||!!this.objectIndex[b]||!!this.predicateIndex[b]};c.IndexedFormula.prototype.nextSymbol=function(b){for(var a=0;;a++){var c=b.uri+"#n"+a;if(!this.mentionsURI(c))return this.sym(c)}};
c.IndexedFormula.prototype.anyStatementMatching=function(b,a,c,f){return(b=this.statementsMatching(b,a,c,f,!0))&&b!=[]?b[0]:void 0};c.IndexedFormula.prototype.statementsMatching=function(b,a,e,f,h){e=[b,a,e,f];b=[];var d=[],g=[];f=[];for(a=0;4>a;a++)b[a]=this.canon(c.term(e[a])),void 0==b[a]?g.push(a):(f.push(a),d[a]=b[a].hashString());if(0==f.length)return this.statements;if(1==f.length)return a=f[0],(a=this.index[a][d[a]])&&h&&1<a.length&&(a=a.slice(0,1)),void 0==a?[]:a;var g=1E10,k;for(e=0;e<f.length;e++){a=
f[e];a=this.index[a][d[a]];if(void 0==a)return[];a.length<g&&(g=a.length,k=e)}a=f[k];d=this.index[a][d[a]];k=f.slice(0,k).concat(f.slice(k+1));f=[];for(var g=["subject","predicate","object","why"],l=0;l<d.length;l++){var m=d[l];for(e=0;e<k.length;e++)if(a=k[e],!this.canon(m[g[a]]).sameTerm(b[a])){m=null;break}if(null!=m&&(f.push(m),h))break}return f};c.IndexedFormula.prototype.remove=function(b){for(var a=[b.subject,b.predicate,b.object,b.why],e=0;4>e;e++){var f=this.canon(a[e]).hashString();void 0!=
this.index[e][f]&&c.Util.RDFArrayRemove(this.index[e][f],b)}c.Util.RDFArrayRemove(this.statements,b)};c.IndexedFormula.prototype.checkStatementList=function(b,a){for(var c=" found in "+["subject","predicate","object","why"][a]+" index.",f=0;f<b.length;f++){st=b[f];for(var h=[st.subject,st.predicate,st.object,st.why],d=function(a,b){for(var c=0;c<a.length;c++)if(a[c].subject.sameTerm(b.subject)&&a[c].predicate.sameTerm(b.predicate)&&a[c].object.sameTerm(b.object)&&a[c].why.sameTerm(b.why))return!0},
g=0;4>g;g++){var k=this.canon(h[g]).hashString();if(void 0==this.index[g][k])throw Error("No "+name[g]+" index for statement "+st+"@"+st.why+c);if(!d(this.index[g][k],st))throw Error("Index for "+name[g]+" does not have statement "+st+"@"+st.why+c);}if(!d(this.statements,st))throw Error("Statement list does not statement "+st+"@"+st.why+c);}};c.IndexedFormula.prototype.check=function(){this.checkStatementList(this.statements);for(var b=0;4>b;b++){var a=this.index[b],c;for(c in a)a.hasOwnProperty(c)&&
this.checkStatementList(a[c],b)}};c.IndexedFormula.prototype.removeMany=function(b,a,c,f,h){b=this.statementsMatching(b,a,c,f,!1);a=[];for(c=0;c<b.length;c++)a.push(b[c]);h&&(a=a.slice(0,h));for(c=0;c<a.length;c++)this.remove(a[c])};c.IndexedFormula.prototype.copyTo=function(b,a,e){e||(e=[]);var f=this.statementsMatching(b);-1!=c.Util.ArrayIndexOf(e,"two-direction")&&f.concat(this.statementsMatching(void 0,void 0,b));for(b=0;b<f.length;b++){var h=f[b];switch(h.object.termType){case "symbol":this.add(a,
h.predicate,h.object);break;case "literal":case "bnode":case "collection":this.add(a,h.predicate,h.object.copy(this))}-1!=c.Util.ArrayIndexOf(e,"delete")&&this.remove(h)}};c.Literal.prototype.copy=function(){return new c.Literal(this.value,this.lang,this.datatype)};c.BlankNode.prototype.copy=function(b){var a=new c.BlankNode;b.copyTo(this,a);return a};c.IndexedFormula.prototype.newUniversal=function(b){b=this.sym(b);this._universalVariables||(this._universalVariables=[]);this._universalVariables.push(b);
return b};c.IndexedFormula.prototype.newExistential=function(b){if(!b)return this.bnode();b=this.sym(b);return this.declareExistential(b)};c.IndexedFormula.prototype.declareExistential=function(b){this._existentialVariables||(this._existentialVariables=[]);this._existentialVariables.push(b);return b};c.IndexedFormula.prototype.formula=function(b){return new c.IndexedFormula(b)};c.IndexedFormula.prototype.close=function(){return this};c.IndexedFormula.prototype.hashString=c.IndexedFormula.prototype.toNT;
return c.IndexedFormula}();c.sparqlUpdateParser=function(b,a,e){var f,h,d=["INSERT","DELETE","WHERE"],g=c.Namespace("http://www.w3.org/ns/pim/patch#"),k=c.N3Parser(a,a,e,e,null,null,"",null),l={},m=function(a,b,c,d,e){return"Line "+(b+1)+" of <"+a+">: Bad syntax:\n   "+e+'\n   at: "'+c.slice(d,d+30)+'"'};f=0;var p=a.sym(e+"#query");for(l.query=p;;){e=k.skipSpace(b,f);if(0>e)return l;if(";"===b[e]){f=k.skipSpace(b,e+1);if(0>f)return l;e=f}var q=!1;for(h=0;h<d.length;h++){var t=d[h];if(b.slice(e,e+
t.length)===t){f=k.skipSpace(b,e+t.length);if(0>f)throw m(k._thisDoc,k.lines,b,e+t.length,"found EOF, needed {...} after "+t);if(("INSERT"===t||"DELETE"===t)&&"DATA"===b.slice(f,f+4)){e=k.skipSpace(b,f+4);if(0>e)throw m(k._thisDoc,k.lines,b,f+4,"needed {...} after INSERT DATA "+t);f=e}q=[];e=k.node(b,f,q);if(0>e)throw m(k._thisDoc,k.lines,b,f,"bad syntax or EOF in {...} after "+t);l[t.toLowerCase()]=q[0];a.add(p,g(t.toLowerCase()),q[0]);q=!0;f=e}}if(!q&&"@prefix"===b.slice(e,e+7)){f=k.directive(b,
e);if(0>f)throw m(k._thisDoc,k.lines,b,f,"bad syntax or EOF after @prefix ");f=k.checkDot(b,f);q=!0}if(!q)throw m(k._thisDoc,k.lines,b,e,"Unknown syntax at start of statememt: '"+b.slice(e).slice(0,20)+"'");}};c.IndexedFormula.prototype.applyPatch=function(b,a,e){var f=this,h=function(c){if(b["delete"]){var g=b["delete"];d&&(g=g.substitute(d));var g=g.statements,k=[],g=g.map(function(b){var c=f.statementsMatching(b.subject,b.predicate,b.object,a);return 0===c.length?(k.push(b),null):c[0]});if(k.length)return e("Couldn't find to delete: "+
k[0]);g.map(function(a){f.remove(a)})}b.insert&&(g=b.insert,d&&(g=g.substitute(d)),g=g.statements,g.map(function(b){b.why=a;f.add(b.subject,b.predicate,b.object,b.why)}));c()},d=null;if(b.where){var g=new c.Query("patch");g.pat=b.where;g.pat.statements.map(function(b){b.why=a});var k=[];f.query(g,function(a){k.push(a)},f.fetcher,function(){if(0==k.length)return e("No match found to be patched:"+b.where);if(1<k.length)return e("Patch ambiguous. No patch done.");d=k[0];h(e)})}else h(e)};c.Query=function(b,
a){this.pat=new c.IndexedFormula;this.vars=[];this.name=b;this.id=a};c.QuerySource=function(){this.queries=[];this.listeners=[];this.addQuery=function(b){var a;if(null===b.name||""===b.name)b.name="Query #"+(this.queries.length+1);b.id=this.queries.length;this.queries.push(b);for(a=0;a<this.listeners.length;a++)null!==this.listeners[a]&&this.listeners[a].addQuery(b)};this.removeQuery=function(b){var a;for(a=0;a<this.listeners.length;a++)null!==this.listeners[a]&&this.listeners[a].removeQuery(b);null!==
this.queries[b.id]&&delete this.queries[b.id]};this.addListener=function(b){var a;this.listeners.push(b);for(a=0;a<this.queries.length;a++)null!==this.queries[a]&&b.addQuery(this.queries[a])};this.removeListener=function(b){var a;for(a=0;a<this.queries.length;a++)null!==this.queries[a]&&b.removeQuery(this.queries[a]);for(a=0;a<this.listeners.length;a++)this.listeners[a]===b&&delete this.listeners[a]}};c.Variable.prototype.isVar=1;c.BlankNode.prototype.isVar=1;c.BlankNode.prototype.isBlank=1;c.Symbol.prototype.isVar=
0;c.Literal.prototype.isVar=0;c.Formula.prototype.isVar=0;c.Collection.prototype.isVar=0;c.IndexedFormula.prototype.query=function(b,a,e,f){function h(a,b){return a.nvars!==b.nvars?a.nvars-b.nvars:a.index.length-b.index.length}var d=function(a){var b="",c;for(c in a)a.hasOwnProperty(c)&&(b+="    "+c+" -> "+a[c]);return b},g=function(a){var b="Bindings: ",c,e=a.length;for(c=0;c<e;c++)b+=d(a[c][0])+";\n\t";return b},k=function(a,b,c,d){var e;if(a.length!==b.length)return[];if(!a.length)return[[[],null]];
var g;a:{g=a[0];var f=b[0],h=c[g];if(void 0===h){if(g.isVar){h=[];h[g]=f;g=[[h,null]];break a}h=g}if(h.complexType)if(g instanceof Array)g=f instanceof Array?k(g,f,c):[];else throw"query.js: oops - code not written yet";else d.redirections[h]&&(h=d.redirections[h]),d.redirections[f]&&(f=d.redirections[f]),g=h.sameTerm(f)?[[[],null]]:[]}if(0===g.length)return g;for(var f=[],l=g.length,r,m,p,q,t,h=0;h<l;h++){r=g[h][0];e=[];for(q in r)r.hasOwnProperty(q)&&(e[q]=r[q]);for(q in c)c.hasOwnProperty(q)&&
(e[q]=c[q]);e=k(a.slice(1),b.slice(1),e,d);p=e.length;for(m=0;m<p;m++){t=e[m][0];for(q in r)r.hasOwnProperty(q)&&(t[q]=r[q]);f.push([t,null])}}return f},l=function(a,b){var c={},d;for(d in a)a.hasOwnProperty(d)&&(c[d]=a[d]);for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c},m=function(a,b){this.trunkBindings=b;this.originalCallback=a;this.branches=[];return this};m.prototype.checkAllDone=function(){var a;for(a=0;a<this.branches.length;a++)if(!this.branches[a].done)return;c.log.debug("OPTIONAL BIDNINGS ALL DONE:");
this.doCallBacks(this.branches.length-1,this.trunkBindings)};m.prototype.doCallBacks=function(a,b){var c;if(0>a)return this.originalCallback(b);for(c=0;c<this.branches[a].results.length;c++)this.doCallBacks(a-1,l(b,this.branches[a].results[c]))};var p=function(a,b){this.count=0;this.done=this.success=!1;this.callback=a;this.onDone=b;return this};p.prototype.reportMatch=function(a){this.callback(a);this.success=!0};p.prototype.reportDone=function(){this.done=!0;c.log.info("Mandatory query branch finished.***");
if(void 0!==this.onDone)this.onDone()};var q=function(a){this.count=0;this.done=!1;this.results=[];this.junction=a;a.branches.push(this);return this};q.prototype.reportMatch=function(a){this.results.push(a)};q.prototype.reportDone=function(){c.log.debug("Optional branch finished - results.length = "+this.results.length);0===this.results.length&&(this.results.push({}),c.log.debug("Optional branch FAILED - that's OK."));this.done=!0;this.junction.checkAllDone()};var t=0,w=function(b,e,g,f,k,h,l){c.log.debug("Match begins, Branch count now: "+
l.count+" for "+l.pattern_debug);var p=b.fetcher?b.fetcher:null,O=e.statements;if(0===O.length){c.log.debug("FOUND MATCH WITH BINDINGS:"+d(g));if(0===e.optional.length)l.reportMatch(g);else{c.log.debug("OPTIONAL: "+e.optional);var O=new m(a,g),F=[],G;for(G=0;G<e.optional.length;G++)F[G]=new q(O),F[G].pattern_debug=e.optional[G];for(G=0;G<e.optional.length;G++)F[G].count+=1,w(b,e.optional[G],g,"",k,a,F[G])}l.count--;c.log.debug("Match ends -- success , Branch count now: "+l.count+" for "+l.pattern_debug)}else{var v=
O.length;if(p){var E="match"+t++,D=function(a,c){var d=a.uri.split("#")[0];p.nowOrWhenFetched(d,void 0,function(c,d,r){c&&console.log("Error following link to <"+a.uri+"> in query: "+d);w(b,e,g,f,k,h,l)})};for(G=0;G<v;G++){F=O[G];if(void 0!==g[F.subject]&&g[F.subject].uri&&p&&"unrequested"===p.getState(c.Util.uri.docpart(g[F.subject].uri))){D(g[F.subject],E);return}if(void 0!==g[F.object]&&g[F.object].uri&&p&&"unrequested"===p.getState(c.Util.uri.docpart(g[F.object].uri))){D(g[F.object],E);return}}}r(b,
e,g,f,k,h,l)}},r=function(a,b,e,f,l,r,m){var p=b.statements,q=p.length,F,t,v,E,D,A,B;for(F=0;F<q;F++){B=p[F];c.log.info("match2: item="+B+", bindingsSoFar="+d(e));var P=a;t=e;var J=void 0,C=v=void 0;A=D=void 0;B.nvars=0;B.index=null;v=[B.subject,B.predicate,B.object];A=[P.subjectIndex,P.predicateIndex,P.objectIndex];for(D=0;3>D;D++)v[D].isVar&&void 0===t[v[D]]?B.nvars++:(J=v[D],C=t[J],J=void 0===C?J:C,P.redirections[J.hashString()]&&(J=P.redirections[J.hashString()]),C=A[D],B.index=C[J.hashString()],
void 0===B.index&&(B.index=[]));null===B.index&&(B.index=P.statements)}p.sort(h);B=p[0];q=a.formula();q.optional=b.optional;q.constraints=b.constraints;q.statements=p.slice(1);c.log.debug(f+"match2 searching "+B.index.length+" for "+B+"; bindings so far="+d(e));F=B.index.length;for(p=P=0;p<F;p++)for(t=B.index[p],J=k([B.subject,B.predicate,B.object],[t.subject,t.predicate,t.object],e,a),c.log.info(f+" From first: "+J.length+": "+g(J)),v=J.length,t=0;t<v;t++){D=[];var C=A=J[t][0],W=b.constraints,X=
!0,Q=void 0,H=void 0;for(Q in C)C.hasOwnProperty(Q)&&W[Q]&&(H=W[Q].test)&&!H(C[Q])&&(X=!1);if(X){for(E in A)A.hasOwnProperty(E)&&(D[E]=A[E]);for(E in e)e.hasOwnProperty(E)&&(D[E]=e[E]);m.count++;P++;w(a,q,D,f+"  ",l,r,m)}else c.log.debug("Branch count CS: "+m.count)}m.count--;0===P&&c.log.debug("Match2 fails completely on "+B);c.log.debug("Match2 ends, Branch count: "+m.count+" for "+m.pattern_debug);0===m.count&&(c.log.debug("Branch finished."),m.reportDone())},A=this;c.log.debug("Query on "+this.statements.length);
var B=new p(a,f);B.count++;setTimeout(function(){w(A,b.pat,b.pat.initBindings,"",e,a,B)},0)};c.queryToSPARQL=function(b){function a(a){var b="";a=a.statements;for(var d in a)c.log.debug("Found statement: "+a),b+=h()+a[d]+"\n";return b}function e(a){var b="",c;for(c in a.constraints)var d=a.constraints[c],b=b+(h()+"FILTER ( "+d.describe(c)+" ) \n");return b}function f(b){for(var k="",l=0;l<b.optional.length;l++)c.log.debug("Found optional query"),k+=h()+"OPTIONAL { \n",d++,k+=a(b.optional[l]),k+=e(b.optional[l]),
k+=f(b.optional[l]),d--,k+=h()+"}\n";return k}function h(){var a="";for(i=0;i<d;i++)a+="    ";return a}var d=0;return function(b){var c=h()+"SELECT ";for(i=0;i<b.vars.length;i++)c+=b.vars[i]+" ";c+="\n";b=b.pat;var l=h()+"WHERE \n{ \n";d++;l+=a(b);l+=e(b);l+=f(b);d--;return c+(l+"}")}(b)};c.SPARQLToQuery=function(b,a,e){function f(a){if(n[a])return n[a];var b=e.variable(a);return n[a]=b}function h(a){return"string"==typeof a&&a.match(/^[\?\$]/)}function d(a){return"string"==typeof a&&a.match(/^<[^>]*>$/)}
function g(a){return d(a)?a.slice(1,a.length-1):a}function k(a){var b=-1==a.indexOf("'")?null:a.indexOf("'"),d=-1==a.indexOf('"')?null:a.indexOf('"');if(!b&&!d){var f=Array(1);f[0]=a;return f}var f=Array(2),h;if(!b||d&&d<b)h='"',b=d;else if(!d||b&&b<d)h="'";else return c.log.error("SQARQL QUERY OOPS!"),f;f[0]=a.slice(0,b);h=a.slice(b+1).indexOf(h);if(-1===h)return c.log.error("SPARQL parsing error: no matching parentheses in literal "+a),a;a.slice(h+b+2).match(/^\^\^/)?(d=a.slice(h+b+2).indexOf(" "),
f[1]=e.literal(a.slice(b+1,b+1+h),"",e.sym(g(a.slice(b+4+h,b+2+h+d)))),f=f.concat(k(a.slice(h+b+3+d)))):a.slice(h+b+2).match(/^@/)?(d=a.slice(h+b+2).indexOf(" "),f[1]=e.literal(a.slice(b+1,b+1+h),a.slice(b+3+h,b+2+h+d),null),f=f.concat(k(a.slice(h+b+2+d)))):(f[1]=e.literal(a.slice(b+1,b+1+h),"",null),c.log.info("Literal found: "+f[1]),f=f.concat(k(a.slice(h+b+2))));return f}function l(a){a=a.replace(/\(/g," ( ").replace(/\)/g," ) ").replace(/</g," <").replace(/>/g,"> ").replace(/{/g," { ").replace(/}/g,
" } ").replace(/[\t\n\r]/g," ").replace(/; /g," ; ").replace(/\. /g," . ").replace(/, /g," , ");c.log.info("New str into spaceDelimit: \n"+a);var b=[];a=a.split(" ");for(var d in a){var e=a[d];"string"==typeof e&&e.match(/[^ \n\t]/)&&(b=b.concat(a[d]))}return b}function m(a,b){for(i=0;i<b.length;i++)if("string"==typeof b[i]&&b[i].toLowerCase()==a.toLowerCase())return i;return null}function p(a,b){var c=[];for(i=0;i<b.length;i++)"string"==typeof b[i]&&b[i].toLowerCase()==a.toLowerCase()&&c.push(i);
return c}function q(a,b,d){c.log.info("Looking for a close bracket of type "+d+" in "+a);var e=0;for(i=0;i<a.length;i++)if(a[i]==b&&e++,a[i]==d&&e--,0>e)return i;c.log.error("Statement had no close parenthesis in SPARQL query");return 0}function t(a){this.describe=function(b){return b+" > "+a.toNT()};this.test=function(b){return b.value.match(/[0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?/)?parseFloat(b.value)>parseFloat(a):b.toNT()>a.toNT()};return this}function w(a){this.describe=function(b){return b+" < "+
a.toNT()};this.test=function(b){return b.value.match(/[0-9]+(\.[0-9]+)?([eE][+-]?[0-9]+)?/)?parseFloat(b.value)<parseFloat(a):b.toNT()<a.toNT()};return this}function r(a){this.describe=function(b){return b+" = "+a.toNT()};this.test=function(b){return a.sameTerm(b)};return this}function A(a){this.describe=function(b){return"REGEXP( '"+a+"' , "+b+" )"};this.test=function(b){var c=new RegExp(a);return b.value?c.test(b.value):!1}}function B(a,b){for(var k=[],l=0;l<a.length;l++)if("string"!=typeof a[l])k[l]=
a[l];else{var n=l,v;v=a[l];v="string"==typeof v?v.replace(/^&lt;/,"<").replace(/&gt;$/,">"):v;a[n]=v;h(a[l])?k[l]=f(a[l].slice(1)):(n=a[l],"string"==typeof n&&(n.match(/^_:/)||n.match(/^$/))?(c.log.info(a[l]+" was identified as a bnode."),k[l]=e.bnode()):d(a[l])?(c.log.info(a[l]+" was identified as a symbol."),k[l]=e.sym(g(a[l]))):(n=a[l],"string"==typeof n&&n.match(/^:|^[^_][^:]*:/)?(c.log.info(a[l]+" was identified as a prefixed symbol"),M[a[l].split(":")[0]]?k[l]=e.sym(a[l]=M[a[l].split(":")[0]]+
a[l].split(":")[1]):(c.log.error("SPARQL error: "+a[l]+" with prefix "+a[l].split(":")[0]+" does not have a correct prefix entry."),k[l]=a[l])):k[l]=a[l]))}for(c.log.debug("WHERE: "+k);m("OPTIONAL",k);)opt=m("OPTIONAL",k),c.log.debug("OPT: "+opt+" "+k[opt]+" in "+k),"{"!=k[opt+1]&&c.log.warn("Bad optional opening bracket in word "+opt),l=q(k.slice(opt+2),"{","}"),-1==l?c.log.error("No matching bracket in word "+opt):(l=k.slice(opt+2,opt+2+l),n=b,c.log.debug("Optional query: "+l+" not yet implemented."),
v=e.formula(),B(l,v),n.optional.push(v),opt=m("OPTIONAL",k),l=q(k.slice(opt+2),"{","}"),k.splice(opt,l+3));for(c.log.debug("WHERE after optionals: "+k);m("FILTER",k);)(n=m("FILTER",k),"("!=k[n+1]&&c.log.warn("Bad filter opening bracket in word "+n),l=q(k.slice(n+2),"(",")"),-1==l)?c.log.error("No matching bracket in word "+n):(l=k.slice(n+2,n+2+l),n=b,3!=l.length||"variable"!=l[0].termType||"symbol"!=l[2].termType&&"literal"!=l[2].termType?6==l.length&&"string"==typeof l[0]&&"regexp"==l[0].toLowerCase()&&
"("==l[1]&&")"==l[5]&&","==l[3]&&"variable"==l[4].termType&&"literal"==l[2].termType&&(c.log.debug("Constraint added: "+l),n.constraints[l[4]]=new A(l[2].value)):"="==l[1]?(c.log.debug("Constraint added: "+l),n.constraints[l[0]]=new r(l[2])):">"==l[1]?(c.log.debug("Constraint added: "+l),n.constraints[l[0]]=new t(l[2])):"<"==l[1]?(c.log.debug("Constraint added: "+l),n.constraints[l[0]]=new w(l[2])):c.log.warn("I don't know how to handle the constraint: "+l),n=m("FILTER",k),l=q(k.slice(n+2),"(",")"),
k.splice(n,l+3));c.log.debug("WHERE after filters and optionals: "+k);l=Array(1);l[0]=-1;var E=l.concat(p(".",k)),n=[];for(v=0;v<E.length-1;v++)n[v]=k.slice(E[v]+1,E[v+1]);for(v in n){c.log.info("s+p+o "+v+" = "+n[v]);k=n[v][0];n[v].splice(0,1);var D=l.concat(p(";",n[v]));D.push(n[v].length);E=[];for(y=0;y<D.length-1;y++)E[y]=n[v].slice(D[y]+1,D[y+1]);for(v in E){c.log.info("p+o "+v+" = "+n[v]);D=E[v][0];E[v].splice(0,1);var u=l.concat(p(",",E[v]));u.push(E[v].length);var V=[];for(y=0;y<u.length-
1;y++)V[y]=E[v].slice(u[y]+1,u[y+1]);for(v in V)u=V[v][0],c.log.info("Subj="+k+" Pred="+D+" Obj="+u),b.add(k,D,u)}}}var n=[];c.log.info("SPARQL input: \n"+b);var u=new c.Query;b=function(a){a=k(a);var b=[],d;for(d in a)b="string"==typeof a[d]?b.concat(l(a[d])):b.concat(a[d]);d=b;for(a=0;a<d.length;a++)"a"==d[a]&&(d[a]="<http://www.w3.org/1999/02/22-rdf-syntax-ns#type>"),"is"==d[a]&&"of"==d[a+2]&&(d.splice(a,1),d.splice(a+1,1),b=d[a-1],d[a-1]=d[a+1],d[a+1]=b);b=d;c.log.info("SPARQL Tokens: "+b);return b}(b);
var M=function(a){var b=p("PREFIX",a),e=[],f;for(f in b){var k=a[b[f]+1],l=a[b[f]+2];"string"==typeof k&&k.match(/:$/)?d(l)?(c.log.info("Prefix found: "+k+" -> "+l),k=k.split(":")[0],l=g(l),e[k]=l):c.log.error("Invalid SPARQL symbol: "+l):c.log.error("Invalid SPARQL prefix: "+k)}return e}(b);M.rdf||(M.rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#");M.rdfs||(M.rdfs="http://www.w3.org/2000/01/rdf-schema#");var U=m("SELECT",b),I=m("WHERE",b);if(0>U||0>I||U>I)return c.log.error("Invalid or nonexistent SELECT and WHERE tags in SPARQL query"),
!1;(function(a,b){c.log.info("SPARQL vars: "+a);for(var d in a)if(h(a[d])){c.log.info("Added "+a[d]+" to query variables from SPARQL");var e=f(a[d].slice(1));b.vars.push(e);e.label=a[d].slice(1)}else c.log.warn("Incorrect SPARQL variable in SELECT: "+a[d])})(b.slice(U+1,I),u);B(b.slice(I+2,b.length-1),u.pat);if(a)return u;for(var C in u.pat.statements)a=u.pat.statements[C],"symbol"==a.subject.termType&&c.fetcher&&c.fetcher.lookUpThing(a.subject,"sparql:"+a.subject),"symbol"==a.object.termType&&c.fetcher&&
c.fetcher.lookUpThing(a.object,"sparql:"+a.object);return u};c.SPARQLResultsInterpreter=function(b,a,e){function f(a){if(!a.name.match(/^xmlns/))return!1;var b=a.name.replace(/^xmlns/,"").replace(/^:/,"").replace(/ /g,"");k[b]=a.value;c.log.info("Prefix: "+b+"\nValue: "+a.value)}function h(a){var b;"string"==typeof a&&a.match(/^:|^[^_][^:]*:/)?(b=a.split(":")[0],a=a.split(":")[1]):b="";if(k[b])return k[b]+a;c.log.error("Incorrect SPARQL results - bad prefix")}function d(a){for(var b=a.childNodes[0],
d=0;d<a.childNodes.length;d++)if(3==a.childNodes[d].nodeType){b=a.childNodes[d];break}if(h(a.nodeName)==q+"uri")return kb.sym(b.nodeValue);if(h(a.nodeName)==q+"literal")return kb.literal(b.nodeValue);if(h(a.nodeName)==q+"unbound")return"unbound";c.log.warn("Don't know how to handle xml binding term "+a);return!1}function g(b){for(var e=[],g=!1,f=0;f<b.childNodes.length;f++)if(1==b.childNodes[f].nodeType)if(h(b.childNodes[f].nodeName)!=q+"binding")c.log.warn("Bad binding node inside result");else{for(var g=
b.childNodes[f],k=makeVar(g.getAttribute("name")),m=null,p=0;p<g.childNodes.length;p++)if(1==g.childNodes[p].nodeType){m=d(g.childNodes[p]);break}if(!m)return c.log.warn("Bad binding"),!1;c.log.info("var: "+k+" binding: "+m);g=!0;"unbound"!=m&&(e[k]=m)}g&&a&&setTimeout(function(){a(e)},0);l.push(e)}var k=[],l=[],m,p;b=b.childNodes[0];var q="http://www.w3.org/2005/sparql-results#";k[""]="";var t;if("sparql"==b.nodeName){for(t=0;t<b.attributes.length;t++)f(b.attributes[t]);for(t=0;t<b.childNodes.length;t++)c.log.info("Type: "+
b.childNodes[t].nodeType+"\nName: "+b.childNodes[t].nodeName+"\nValue: "+b.childNodes[t].nodeValue),1==b.childNodes[t].nodeType&&h(b.childNodes[t].nodeName)==q+"head"?m=b.childNodes[t]:1==b.childNodes[t].nodeType&&h(b.childNodes[t].nodeName)==q+"results"&&(p=b.childNodes[t]);if(p||m){for(t=0;t<m.childNodes.length;t++)1==m.childNodes[t].nodeType&&h(m.childNodes[t].nodeName)==q+"variable"&&c.log.info("Var: "+m.childNodes[t].getAttribute("name"));for(t=0;t<p.childNodes.length;t++)h(p.childNodes[t].nodeName)==
q+"result"&&(c.log.info("Result # "+t),g(p.childNodes[t]));e&&e();return l}}c.log.error("Bad SPARQL results XML")};c.sparqlUpdate=function(){var b=function(a){this.store=a;this.ifps={};this.fps={};this.ns={};this.ns.link=c.Namespace("http://www.w3.org/2007/ont/link#");this.ns.http=c.Namespace("http://www.w3.org/2007/ont/http#");this.ns.httph=c.Namespace("http://www.w3.org/2007/ont/httph#");this.ns.rdf=c.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");this.ns.rdfs=c.Namespace("http://www.w3.org/2000/01/rdf-schema#");
this.ns.rdf=c.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");this.ns.owl=c.Namespace("http://www.w3.org/2002/07/owl#")};b.prototype.editable=function(a,b){if(!a)return!1;b||(b=tabulator.kb);if("file:///"==a.slice(0,8)){if(b.holds(b.sym(a),tabulator.ns.rdf("type"),tabulator.ns.link("MachineEditableDocument")))return"LOCALFILE";var f=b.statementsMatching(b.sym(a),void 0,void 0);tabulator.log.warn("sparql.editable: Not MachineEditableDocument file "+a+"\n");tabulator.log.warn(f.map(function(a){return a.toNT()}).join("\n"));
return!1}for(var h,f=!1,d=b.each(void 0,this.ns.link("requestedURI"),c.uri.docpart(a)),g=0;g<d.length;g++)if(h=d[g],void 0!==h){var k=b.any(h,this.ns.link("response"));if(void 0!==h){var l=b.each(k,this.ns.httph("ms-author-via"));if(l.length)for(h=0;h<l.length;h++){var m=l[h].value.trim();if(0<=m.indexOf("SPARQL"))return"SPARQL";if(0<=m.indexOf("DAV"))return"DAV"}k=b.each(k,this.ns.http("status"));if(k.length)for(h=0;h<k.length;h++)if(200==k[h]||404==k[h])f=!0}else tabulator.log.warn("sparql.editable: No response for "+
a+"\n")}if(0==d.length)tabulator.log.warn("sparql.editable: No request for "+a+"\n");else if(f)return!1;tabulator.log.warn("sparql.editable: inconclusive for "+a+"\n")};b.prototype.anonymize=function(a){return"_:"==a.toNT().substr(0,2)&&this._mentioned(a)?"?"+a.toNT().substr(2):a.toNT()};b.prototype.anonymizeNT=function(a){return this.anonymize(a.subject)+" "+this.anonymize(a.predicate)+" "+this.anonymize(a.object)+" ."};b.prototype._statement_bnodes=function(a){return[a.subject,a.predicate,a.object].filter(function(a){return a.isBlank})};
b.prototype._statement_array_bnodes=function(a){for(var b=[],c=0;c<a.length;c++)b=b.concat(this._statement_bnodes(a[c]));b.sort();bnodes2=[];for(a=0;a<b.length;a++)0!=a&&b[a].sameTerm(b[a-1])||bnodes2.push(b[a]);return bnodes2};b.prototype._cache_ifps=function(){this.ifps={};for(var a=this.store.each(void 0,this.ns.rdf("type"),this.ns.owl("InverseFunctionalProperty")),b=0;b<a.length;b++)this.ifps[a[b].uri]=!0;this.fps={};a=this.store.each(void 0,this.ns.rdf("type"),this.ns.owl("FunctionalProperty"));
for(b=0;b<a.length;b++)this.fps[a[b].uri]=!0};b.prototype._bnode_context2=function(a,b,c){for(var h=this.store.statementsMatching(void 0,void 0,a,b),d=0;d<h.length;d++)if(this.fps[h[d].predicate.uri]){var g=h[d].subject;if(!g.isBlank)return[h[d]];if(c&&(g=this._bnode_context2(g,b,c-1),null!=g))return g.concat([h[d]])}h=this.store.statementsMatching(a,void 0,void 0,b);for(d=0;d<h.length;d++)if(this.ifps[h[d].predicate.uri]){g=h[d].object;if(!g.isBlank)return[h[d]];if(c&&(g=this._bnode_context2(g,b,
c-1),void 0!=g))return g.concat([h[d]])}return null};b.prototype._bnode_context_1=function(a,b){for(var c=0;3>c;c++){var h=this._bnode_context2(a,b,c);if(null!==h)return h}throw"Unable to uniquely identify bnode: "+a.toNT();};b.prototype._mentioned=function(a){return 0!==this.store.statementsMatching(a).length||0!==this.store.statementsMatching(void 0,a).length||0!==this.store.statementsMatching(void 0,void 0,a).length};b.prototype._bnode_context=function(a,b){var c=[];if(a.length){this._cache_ifps();
for(var h=0;h<a.length;h++){var d=a[h];this._mentioned(d)&&(c=c.concat(this._bnode_context_1(d,b)))}}return c};b.prototype._statement_context=function(a){var b=this._statement_bnodes(a);return this._bnode_context(b,a.why)};b.prototype._context_where=function(a){var b=this;return void 0==a||0==a.length?"":"WHERE { "+a.map(function(a){return b.anonymizeNT(a)}).join("\n")+" }\n"};b.prototype._fire=function(a,b,f){if(!a)throw"No URI given for remote editing operation: "+b;tabulator.log.info("sparql: sending update to <"+
a+">\n   query="+b+"\n");var h=c.Util.XMLHTTPFactory();h.onreadystatechange=function(){if(4==h.readyState){var c=!h.status||200<=h.status&&300>h.status;c?tabulator.log.debug("sparql: update Ok for <"+a+">"):tabulator.log.error("sparql: update failed for <"+a+"> status="+h.status+", "+h.statusText+", body length="+h.responseText.length+"\n   for query: "+b);f(a,c,h.responseText,h)}};if(!tabulator.isExtension)try{c.Util.enablePrivilege("UniversalBrowserRead")}catch(d){alert("Failed to get privileges: "+
d)}h.open("POST",a,!0);h.setRequestHeader("Content-type","application/sparql-update");h.send(b)};b.prototype.update_statement=function(a){if(!a||void 0!=a.why){var b=this,c=this._statement_context(a);return{statement:a?[a.subject,a.predicate,a.object,a.why]:void 0,statementNT:a?this.anonymizeNT(a):void 0,where:b._context_where(c),set_object:function(a,c){query=this.where;query+="DELETE DATA { "+this.statementNT+" } ;\n";query+="INSERT DATA { "+this.anonymize(this.statement[0])+" "+this.anonymize(this.statement[1])+
" "+this.anonymize(a)+"  . }\n";b._fire(this.statement[3].uri,query,c)}}}};b.prototype.insert_statement=function(a,b){var c=a instanceof Array?a[0]:a,h=this._context_where(this._statement_context(c));if(a instanceof Array){for(var d="",g=0;g<a.length;g++)d+=a[g]+"\n";h+="INSERT DATA { "+d+" }\n"}else h+="INSERT DATA { "+this.anonymize(a.subject)+" "+this.anonymize(a.predicate)+" "+this.anonymize(a.object)+"  . }\n";this._fire(c.why.uri,h,b)};b.prototype.delete_statement=function(a,b){var c=a instanceof
Array?a[0]:a,h=this._context_where(this._statement_context(c));if(a instanceof Array){for(var d="",g=0;g<a.length;g++)d+=a[g]+"\n";h+="DELETE DATA { "+d+" }\n"}else h+="DELETE DATA { "+this.anonymize(a.subject)+" "+this.anonymize(a.predicate)+" "+this.anonymize(a.object)+"  . }\n";this._fire(c.why.uri,h,b)};b.prototype.update=function(a,b,f){var h=this.store;tabulator.log.info("update called");var d=void 0==a?[]:a instanceof c.IndexedFormula?a.statements:a instanceof Array?a:[a],g=void 0==b?[]:b instanceof
c.IndexedFormula?b.statements:b instanceof Array?b:[b];if(!(d instanceof Array))throw"Type Error "+typeof d+": "+d;if(!(g instanceof Array))throw"Type Error "+typeof g+": "+g;if(0===d.length&&0===g.length)return f(null,!0);var k=d.length?d[0].why:g[0].why;d.map(function(a){if(!k.sameTerm(a.why))throw"sparql update: destination "+k+" inconsistent with ds "+a.why;});g.map(function(a){if(!k.sameTerm(a.why))throw"sparql update: destination = "+k+" inconsistent with st.why ="+a.why;});a=this.editable(k.uri,
h);if(!a)throw"Can't make changes in uneditable "+k;if(0<=a.indexOf("SPARQL")){var l=[];d.length&&(l=this._statement_array_bnodes(d));g.length&&(l=l.concat(this._statement_array_bnodes(g)));var l=this._bnode_context(l,k),m=this._context_where(l),p="";if(m.length){if(d.length){p+="DELETE { ";for(l=0;l<d.length;l++)p+=this.anonymizeNT(d[l])+"\n";p+=" }\n"}if(g.length){p+="INSERT { ";for(l=0;l<g.length;l++)p+=this.anonymizeNT(g[l])+"\n";p+=" }\n"}p+=m}else{if(d.length){p+="DELETE DATA { ";for(l=0;l<
d.length;l++)p+=this.anonymizeNT(d[l])+"\n";p+=" } \n"}if(g.length){d.length&&(p+=" ; ");p+="INSERT DATA { ";for(l=0;l<g.length;l++)p+=this.anonymizeNT(g[l])+"\n";p+=" }\n"}}this._fire(k.uri,p,function(a,b,c,e){tabulator.log.info("\t sparql: Return success="+b+" for query "+p+"\n");if(b){for(var l=0;l<d.length;l++)try{h.remove(d[l])}catch(n){f(a,!1,"sparqlUpdate: Remote OK but error deleting statemmnt "+d[l]+" from local store:\n"+n)}for(l=0;l<g.length;l++)h.add(g[l].subject,g[l].predicate,g[l].object,
k)}f(a,b,c,e)})}else if(0<=a.indexOf("DAV")){l=h.any(k,this.ns.link("request"));if(!l)throw"No record of our HTTP GET request for document: "+k;var q=h.any(l,this.ns.link("response"));if(!q)return null;for(var t=h.the(q,this.ns.httph("content-type")).value,w=h.statementsMatching(void 0,void 0,void 0,k).slice(),l=0;l<d.length;l++)c.Util.RDFArrayRemove(w,d[l]);for(l=0;l<g.length;l++)w.push(g[l]);var r=c.Serializer(h);r.suggestNamespaces(h.namespaces);r.setBase(k.uri);switch(t){case "application/rdf+xml":m=
r.statementsToXML(w);break;case "text/n3":case "text/turtle":case "application/x-turtle":case "application/n3":m=r.statementsToN3(w);break;default:throw"Content-type "+t+" not supported for data write";}(l=h.the(q,this.ns.httph("content-location")))&&(targetURI=c.uri.join(l.value,targetURI));var A=c.Util.XMLHTTPFactory();A.onreadystatechange=function(){if(4==A.readyState){var a=!A.status||200<=A.status&&300>A.status;if(a){for(var b=0;b<d.length;b++)h.remove(d[b]);for(b=0;b<g.length;b++)h.add(g[b].subject,
g[b].predicate,g[b].object,k)}f(k.uri,a,A.responseText)}};A.open("PUT",targetURI,!0);A.setRequestHeader("Content-type",t);A.send(m)}else if(0<=a.indexOf("LOCALFILE"))try{tabulator.log.info("Writing back to local file\n");w=h.statementsMatching(void 0,void 0,void 0,k).slice();for(l=0;l<d.length;l++)c.Util.RDFArrayRemove(w,d[l]);for(l=0;l<g.length;l++)w.push(g[l]);r=c.Serializer(h);r.suggestNamespaces(h.namespaces);r.setBase(k.uri);t=k.uri.lastIndexOf(".");if(1>t)throw"Rewriting file: No filename extension: "+
k.uri;q=k.uri.slice(t+1);switch(q){case "rdf":case "owl":case "xml":m=r.statementsToXML(w);break;case "n3":case "nt":case "ttl":m=r.statementsToN3(w);break;default:throw"File extension ."+q+" not supported for data write";}dump("Writing back: <<<"+m+">>>\n");var B=k.uri.slice(7),n=Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);n.initWithPath(B);if(!n.exists())throw"Rewriting file <"+k.uri+"> but it does not exist!";var u=Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
u.init(n,42,438,0);u.write(m,m.length);u.close();for(l=0;l<d.length;l++)h.remove(d[l]);for(l=0;l<g.length;l++)h.add(g[l].subject,g[l].predicate,g[l].object,k);f(k.uri,!0,"")}catch(M){f(k.uri,!1,"Exception trying to write back file <"+k.uri+">\n"+tabulator.Util.stackString(M))}else throw"Unhandled edit method: '"+a+"' for "+k;};b.prototype.put=function(a,b,f,h){var d=this.store;if("string"!==typeof b){var g=c.Serializer(d);g.suggestNamespaces(d.namespaces);g.setBase(a.uri);switch(f){case "application/rdf+xml":b=
g.statementsToXML(b);break;case "text/n3":case "text/turtle":case "application/x-turtle":case "application/n3":b=g.statementsToN3(b);break;default:throw"Content-type "+f+" not supported for data PUT";}}var k=c.Util.XMLHTTPFactory();k.onreadystatechange=function(){4==k.readyState&&h(a.uri,!k.status||200<=k.status&&300>k.status,k.responseText,k)};k.open("PUT",a.uri,!0);k.setRequestHeader("Content-type",f);k.send(b)};return b}();c.jsonParser=function(){return{parseJSON:function(b,a,c){var f,h,d={},g=
c.sym(a);for(x in b){0===x.indexOf("_:")?d[x]?a=d[x]:(a=c.bnode(x),d[x]=a):a=c.sym(x);var k=b[x];for(y in k){var l=k[y];f=c.sym(y);for(z in l){var m=l[z];if("uri"===m.type)h=c.sym(m.value),c.add(a,f,h,g);else if("bnode"===m.type)d[m.value]?h=d[m.value]:(h=c.bnode(m.value),d[m.value]=h),c.add(a,f,h,g);else if("literal"===m.type)h=m.datatype?c.literal(m.value,void 0,c.sym(m.datatype)):m.lang?c.literal(m.value,m.lang):c.literal(m.value),c.add(a,f,h,g);else throw"error: unexpected termtype: "+z.type;
}}}}}}();c.Serializer=function(){var b=function(a){this.flags="";this.base=null;this.prefixes=[];this.namespacesUsed=[];this.keywords=["a"];this.prefixchars="abcdefghijklmnopqustuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";this.incoming=null;this.formulas=[];this.store=a};b.prototype.setBase=function(a){this.base=a};b.prototype.setFlags=function(a){this.flags=a?a:""};b.prototype.toStr=function(a){var b=a.toNT();"formula"==a.termType&&(this.formulas[b]=a);return b};b.prototype.fromStr=function(a){if("{"==a[0]){var b=
this.formulas[a];b||alert("No formula object for "+a);return b}return this.store.fromNT(a)};b.prototype.suggestPrefix=function(a,b){"default"!==a.slice(0,7)&&"ns"!==a.slice(0,2)&&(this.prefixes[b]=a)};b.prototype.suggestNamespaces=function(a){for(var b in a)this.prefixes[a[b]]=b};b.prototype.makeUpPrefix=function(a){function c(g){if(h[g]||!b.prototype.validPrefix.test(g)||"ns"===g)return!1;d=this.prefixes[a]=g;return!0}var f=a,h=[],d,c=c.bind(this),g;for(g in this.prefixes)h[this.prefixes[g]]=g;0<=
"#/".indexOf(f[f.length-1])&&(f=f.slice(0,-1));g=f.lastIndexOf("/");0<=g&&(f=f.slice(g+1));for(g=0;g<f.length;)if(this.prefixchars.indexOf(f[g]))g++;else break;f=f.slice(0,g);if(6>f.length&&c(f)||c(f.slice(0,3))||c(f.slice(0,2))||c(f.slice(0,4))||c(f.slice(0,1))||c(f.slice(0,5)))return d;b.prototype.validPrefix.test(f)||(f="n");for(g=0;;g++)if(c(f.slice(0,3)+g))return d};b.prototype.rootSubjects=function(a){for(var b={},c={},h=0;h<a.length;h++){var d=a[h];[d.subject,d.predicate,d.object].map(function(a){"bnode"==
a.termType&&a.toNT()});var g=a[h].object;b.hasOwnProperty(g)||(b[g]=[]);b[g].push(d.subject);(g=c[this.toStr(d.subject)])||(g=[]);g.push(d);c[this.toStr(d.subject)]=g}a=[];for(var k in c)c.hasOwnProperty(k)&&(g=this.fromStr(k),"bnode"==g.termType&&b[g]&&1==b[g].length||a.push(g));this.incoming=b;k={};for(h=0;h<a.length;h++)k[a[h].toNT()]=!0;return{roots:a,subjects:c,rootsHash:k,incoming:b}};b.prototype.toN3=function(a){return this.statementsToN3(a.statements)};b.prototype._notQNameChars="\t\r\n !\"#$%&'()*.,+/;<=>?@[\\]^`{|}~";
b.prototype._notNameChars=b.prototype._notQNameChars+":";b.prototype.statementsToN3=function(a){function e(a){a=this.rootSubjects(a);for(var b=a.roots,c=[],d=0;d<b.length;d++)c.push(f(b[d],a));return c}function f(a,b){return"bnode"!=a.termType||b.incoming[a]?[g(a,b)].concat([h(a,b)]).concat(["."]):d(a,b,!0).concat(["."])}function h(a,b){var c=[],f=null,e=b.subjects[this.toStr(a)];if("undefined"==typeof e)throw"Cant find statements for "+a;e.sort();for(var k=[],h=0;h<e.length;h++){var m=e[h];m.predicate.uri==
f?k.push(","):(f&&(c=c.concat([k]).concat([";"]),k=[]),c.push(l[m.predicate.uri]?l[m.predicate.uri]:g(m.predicate,b)));f=m.predicate.uri;k.push(d(m.object,b))}return c=c.concat([k])}function d(a,b,c){return"bnode"==a.termType&&b.subjects[this.toStr(a)]&&(c||void 0==b.rootsHash[a.toNT()])?["["].concat(h(a,b)).concat(["]"]):g(a,b)}function g(a,b){switch(a.termType){case "formula":var c=["{"],c=c.concat(e(a.statements));return c.concat(["}"]);case "collection":c=["("];for(i=0;i<a.elements.length;i++)c.push([d(a.elements[i],
b)]);c.push(")");return c;default:return this.atomicTermToN3(a)}}function k(){var a="";this.defaultNamespace&&(a+="@prefix : <"+this.defaultNamespace+">.\n");for(var b in this.prefixes)this.prefixes.hasOwnProperty(b)&&this.namespacesUsed[b]&&(a+="@prefix "+this.prefixes[b]+": <"+c.uri.refTo(this.base,b)+">.\n");return a+"\n"}var l={"http://www.w3.org/2002/07/owl#sameAs":"=","http://www.w3.org/2000/10/swap/log#implies":"=>","http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"a"},m=function(a){for(var b=
"",c=0;c<a.length;c++){var d=a[c],d="string"==typeof d?d:m(d);0!=c&&","!=d&&";"!=d&&(b+=" ");b+=d}return b},p=function(a,b){var c="",d=1E5;b||(b=0);for(var g=0;g<a.length;g++){var f=a[g];if("string"!=typeof f){var e=p(f,b+1);if(e.length<10*(80-4*b)&&0>e.indexOf('"""')){var k=m(f);k.length<80-4*b&&(f="   "+k,e="")}e&&(d=1E4);c+=e}if("string"==typeof f){if("1"==f.length&&"\n"==c.slice(-1))if(0<=",.;".indexOf(f)){c=c.slice(0,-1)+f+"\n";d+=1;continue}else if(0<="])}".indexOf(f)){c=c.slice(0,-1)+" "+f+
"\n";d+=2;continue}if(d<4*b+4)c=c.slice(0,-1)+" "+f+"\n",d+=f.length+1;else{d="";for(e=0;e<4*b;e++)d+=" ";k=d+f;c+=k+"\n";d=k.length}}}return c},e=e.bind(this),h=h.bind(this),d=d.bind(this);b.prototype.termToN3=g;g=g.bind(this);k=k.bind(this);a=e(a);return k()+p(a,-1)};b.prototype.atomicTermToN3=function(a,b){switch(a.termType){case "bnode":case "variable":return a.toNT();case "literal":if(a.datatype)switch(a.datatype.uri){case "http://www.w3.org/2001/XMLSchema#integer":return a.value.toString();
case "http://www.w3.org/2001/XMLSchema#boolean":return a.value?"true":"false"}var c=this.stringToN3(a.value);a.lang&&(c+="@"+a.lang);a.datatype&&(c+="^^"+this.termToN3(a.datatype,b));return c;case "symbol":return this.symbolToN3(a);default:throw"Internal: atomicTermToN3 cannot handle "+a+" of termType+"+a.termType;}};b.prototype.validPrefix=new RegExp(/^[a-zA-Z][a-zA-Z0-9]*$/);b.prototype.forbidden1=new RegExp(/[\\"\b\f\r\v\t\n\u0080-\uffff]/gm);b.prototype.forbidden3=new RegExp(/[\\"\b\f\r\v\u0080-\uffff]/gm);
b.prototype.stringToN3=function(a,c){c||(c="e");var f="",h=0,d=0,g,k;20<a.length&&'"'!=a.slice(-1)&&0>c.indexOf("n")&&(0<a.indexOf("\n")||0<a.indexOf('"'))?(g='"""',k=b.prototype.forbidden3):(g='"',k=b.prototype.forbidden1);for(h=0;h<a.length;){k.lastIndex=0;if(null==k.exec(a.slice(h)))break;d=h+k.lastIndex-1;f+=a.slice(h,d);h=a[d];if('"'==h&&'"""'==g&&'"""'!=a.slice(d,d+3))f+=h;else var l='\b\f\r\t\v\n\\"'.indexOf(h),f=0<=l?f+("\\"+'bfrtvn\\"'[l]):0<=c.indexOf("e")?f+("\\u"+("000"+h.charCodeAt(0).toString(16).toLowerCase()).slice(-4)):
f+h;h=d+1}return g+f+a.slice(h)+g};b.prototype.symbolToN3=function(a){a=a.uri;var e=a.indexOf("#");0>e&&0>this.flags.indexOf("/")&&(e=a.lastIndexOf("/"));if(0<=e&&0>this.flags.indexOf("p")){for(var f=!0,h=e+1;h<a.length;h++)if(0<=b.prototype._notNameChars.indexOf(a[h])){f=!1;break}if(a.slice(0,e)==this.base)return"<#"+a.slice(e+1)+">";if(f){f=a.slice(e+1);e=a.slice(0,e+1);if(this.defaultNamespace&&this.defaultNamespace==e&&0>this.flags.indexOf("d"))return 0<=this.flags.indexOf("k")&&0>this.keyords.indexOf(f)?
f:":"+f;(h=this.prefixes[e])||(h=this.makeUpPrefix(e));if(h)return this.namespacesUsed[e]=!0,h+":"+f}}if(0>this.flags.indexOf("r")&&this.base)a=c.uri.refTo(this.base,a);else if(0<=this.flags.indexOf("u")){e="";for(h=0;h<a.length;h++)f=a.charCodeAt(h),e=65535<f?e+("\\U"+("00000000"+f.toString(16)).slice(-8)):126<f?e+("\\u"+("0000"+f.toString(16)).slice(-4)):e+a[h];a=e}else a=encodeURI(a);return"<"+a+">"};b.prototype.writeStore=function(a){var b=this.store,c=b.fetcher,c=c&&c.appNode,h=b.statementsMatching(void 0,
b.sym("http://www.w3.org/2007/ont/link#requestedURI")).map(function(a){return a.subject});c&&h.push(c);var d=[];h.map(function(a){d=d.concat(b.statementsMatching(void 0,void 0,void 0,a))});a(this.statementsToN3(d));h=this.store.index[3];for(s in h)h=b.fromNT(s),c&&h.sameTerm(c)||a("\n"+this.atomicTermToN3(h)+" "+this.atomicTermToN3(b.sym("http://www.w3.org/2000/10/swap/log#"))+" { "+this.statementsToN3(b.statementsMatching(void 0,void 0,void 0,h))+" }.\n")};b.prototype.statementsToXML=function(a){function e(a){this.suggestPrefix("rdf",
"http://www.w3.org/1999/02/22-rdf-syntax-ns#");a=this.rootSubjects(a);for(var b=a.roots,c=[],g=0;g<b.length;g++)T=b[g],c.push(d(T,a));return c}function f(a){return"undefined"==typeof a?"@@@undefined@@@@":a.replace(/[&<"]/g,function(a){switch(a[0]){case "&":return"&amp;";case "<":return"&lt;";case '"':return"&quot;"}})}function h(a){return f(this.base?c.Util.uri.refTo(this.base,a.uri):a.uri)}function d(a,b){var e=[],k,m,p,q=b.subjects[this.toStr(a)];if("undefined"==typeof q)throw"Serializing XML - Cant find statements for "+
a;q.sort(function(a,b){var c=a.predicate.uri,d=b.predicate.uri;if("http://www.w3.org/1999/02/22-rdf-syntax-ns#_"==c.substring(0,44)||"http://www.w3.org/1999/02/22-rdf-syntax-ns#_"==d.substring(0,44))return c.localeCompare(d);var g=c.substring(44),e=d.substring(44),f=parseInt(g),k=parseInt(e);return isNaN(f)||isNaN(k)||f!=g||k!=e?c.localeCompare(d):f-k});for(var t=0;t<q.length;t++)if(p=q[t],"http://www.w3.org/1999/02/22-rdf-syntax-ns#type"!=p.predicate.uri||k||"symbol"!=p.object.termType){m=p.predicate;
if("http://www.w3.org/1999/02/22-rdf-syntax-ns#_"==m.uri.substr(0,44)){var w=m.uri.substr(44),C=parseInt(w);w==C.toString()&&(m=new c.Symbol("http://www.w3.org/1999/02/22-rdf-syntax-ns#li"))}m=l(m);switch(p.object.termType){case "bnode":e=1==b.incoming[p.object].length?e.concat(["<"+m+">",d(p.object,b),"</"+m+">"]):e.concat(["<"+m+' rdf:nodeID="'+p.object.toNT().slice(2)+'"/>']);break;case "symbol":e=e.concat(["<"+m+' rdf:resource="'+h(p.object)+'"/>']);break;case "literal":e=e.concat(["<"+m+(p.object.dt?
' rdf:datatype="'+f(p.object.dt.uri)+'"':"")+(p.object.lang?' xml:lang="'+p.object.lang+'"':"")+">"+f(p.object.value)+"</"+m+">"]);break;case "collection":e=e.concat(["<"+m+' rdf:parseType="Collection">',g(p.object,b),"</"+m+">"]);break;default:throw"Can't serialize object of type "+p.object.termType+" into XML";}}else k=p.object;k=k?l(k):"rdf:Description";p="";"bnode"==a.termType?b.incoming[a]&&1==b.incoming[a].length||(p=' rdf:nodeID="'+a.toNT().slice(2)+'"'):p=' rdf:about="'+h(a)+'"';return["<"+
k+p+">"].concat([e]).concat(["</"+k+">"])}function g(a,b){for(var c=[],g=0;g<a.elements.length;g++)c.push(d(a.elements[g],b));return c}function k(a,b){var c=[],d=b.subjects[this.toStr(a)];if(void 0==d)return c;d.sort();for(var e=0;e<d.length;e++){var m=d[e];switch(m.object.termType){case "bnode":c=b.rootsHash[m.object.toNT()]?c.concat(["<"+l(m.predicate)+' rdf:nodeID="'+m.object.toNT().slice(2)+'">',"</"+l(m.predicate)+">"]):c.concat(["<"+l(m.predicate)+' rdf:parseType="Resource">',k(m.object,b),
"</"+l(m.predicate)+">"]);break;case "symbol":c=c.concat(["<"+l(m.predicate)+' rdf:resource="'+h(m.object)+'"/>']);break;case "literal":c=c.concat(["<"+l(m.predicate)+(m.object.datatype?' rdf:datatype="'+f(m.object.datatype.uri)+'"':"")+(m.object.lang?' xml:lang="'+m.object.lang+'"':"")+">"+f(m.object.value)+"</"+l(m.predicate)+">"]);break;case "collection":c=c.concat(["<"+l(m.predicate)+' rdf:parseType="Collection">',g(m.object,b),"</"+l(m.predicate)+">"]);break;default:throw"Can't serialize object of type "+
m.object.termType+" into XML";}}return c}function l(a){var c=a.uri,d=c.indexOf("#");0>d&&0>this.flags.indexOf("/")&&(d=c.lastIndexOf("/"));if(0>d)throw"Cannot make qname out of <"+c+">";for(a=d+1;a<c.length;a++)if(0<=b.prototype._notNameChars.indexOf(c[a]))throw'Invalid character "'+c[a]+'" cannot be in XML qname for URI: '+c;a=c.slice(d+1);c=c.slice(0,d+1);if(this.defaultNamespace&&this.defaultNamespace==c&&0>this.flags.indexOf("d"))return a;(d=this.prefixes[c])||(d=this.makeUpPrefix(c));m[c]=!0;
return d+":"+a}var m=[];m["http://www.w3.org/1999/02/22-rdf-syntax-ns#"]=!0;var p=function(a){for(var b="",c=0;c<a.length;c++)var d=a[c],d="string"==typeof d?d:p(d),b=b+d;return b},q=function(a,b){var c="",d=1E5;b||(b=0);for(var g=0;g<a.length;g++){var e=a[g];if("string"!=typeof e){var f=q(e,b+1);if(f.length<10*(80-4*b)&&0>f.indexOf('"""')){var k=p(e);k.length<80-4*b&&(e="   "+k,f="")}f&&(d=1E4);c+=f}if("string"==typeof e)if(d<4*b+4)c=c.slice(0,-1)+" "+e+"\n",d+=e.length+1;else{d="";for(f=0;f<4*b;f++)d+=
" ";k=d+e;c+=k+"\n";d=k.length}}return c},e=e.bind(this),h=h.bind(this),d=d.bind(this),k=k.bind(this),l=l.bind(this);a=e(a);var t="<rdf:RDF";this.defaultNamespace&&(t+=' xmlns="'+f(this.defaultNamespace)+'"');for(var w in m)m.hasOwnProperty(w)&&(t+="\n xmlns:"+this.prefixes[w]+'="'+f(w)+'"');return q([t+">",a,"</rdf:RDF>"],-1)};return function(a){return new b(a)}}();var L=function(b,a){return function(){return b.apply(a,arguments)}},H={}.hasOwnProperty;if("undefined"===typeof c||null===c)c={};c.UpdatesSocket=
function(){function b(a,b){this.parent=a;this.via=b;this.subscribe=L(this.subscribe,this);this.onError=L(this.onError,this);this.onMessage=L(this.onMessage,this);this.onClose=L(this.onClose,this);this.onOpen=L(this.onOpen,this);this._subscribe=L(this._subscribe,this);this._send=L(this._send,this);this.connected=!1;this.pending={};this.subscribed={};this.socket={};try{this.socket=new WebSocket(b),this.socket.onopen=this.onOpen,this.socket.onclose=this.onClose,this.socket.onmessage=this.onMessage,this.socket.onerror=
this.onError}catch(c){this.onError(c)}}b.prototype._decode=function(a){var b,c,h,d;h={};var g,k;k=a.split("&");a=[];d=0;for(g=k.length;d<g;d++)b=k[d],a.push(b.split("="));for(c in a)b=a[c],d=[decodeURIComponent(b[0]),decodeURIComponent(b[1])],b=d[0],d=d[1],null==h[b]&&(h[b]=[]),h[b].push(d);return h};b.prototype._send=function(a,b,c){var h;a=[a,b,c].join(" ");return"function"===typeof(h=this.socket).send?h.send(a):void 0};b.prototype._subscribe=function(a){this._send("sub",a,"");return this.subscribed[a]=
!0};b.prototype.onOpen=function(a){var b;this.connected=!0;a=[];for(b in this.pending)delete this.pending[b],a.push(this._subscribe(b));return a};b.prototype.onClose=function(a){var b;this.connected=!1;for(b in this.subscribed)this.pending[b]=!0;return this.subscribed={}};b.prototype.onMessage=function(a){var b;a=a.data.split(" ");if("ping"===a[0])return"function"===typeof(b=this.socket).send?b.send("pong "+a.slice(1).join(" ")):void 0;if("pub"===a[0])return this.parent.onUpdate(a[1],this._decode(a[2]))};
b.prototype.onError=function(a){throw"onError"+a;};b.prototype.subscribe=function(a){return this.connected?this._subscribe(a):this.pending[a]=!0};return b}();c.UpdatesVia=function(){function b(a){this.fetcher=a;this.onUpdate=L(this.onUpdate,this);this.onHeaders=L(this.onHeaders,this);this.register=L(this.register,this);this.graph={};this.via={}}b.prototype.register=function(a,b){null==this.via[a]&&(this.via[a]=new c.UpdatesSocket(this,a));return this.via[a].subscribe(b)};b.prototype.onHeaders=function(a){var b,
c;if(null==a.headers||"undefined"===typeof WebSocket||null===WebSocket)return!0;b=a.headers.etag;c=a.headers["updates-via"];a=a.uri;b&&c&&(this.graph[a]={etag:b,via:c},this.register(c,a));return!0};b.prototype.onUpdate=function(a,b){return this.fetcher.refresh(c.sym(a))};return b}();if(null!=("undefined"!==typeof module&&null!==module?module.exports:void 0))for(C in c)H.call(c,C)&&(N=c[C],module.exports[C]=N);c.Fetcher=function(b,a,e){this.store=b;this.thisURI="http://dig.csail.mit.edu/2005/ajar/ajaw/rdf/sources.js#SourceFetcher";
this.timeout=a?a:3E4;this.async=null!=e?e:!0;this.appNode=this.store.bnode();this.store.fetcher=this;this.requested={};this.lookedUp={};this.handlers=[];this.mediatypes={};var f=this,h=this.store,d={};d.link=c.Namespace("http://www.w3.org/2007/ont/link#");d.http=c.Namespace("http://www.w3.org/2007/ont/http#");d.httph=c.Namespace("http://www.w3.org/2007/ont/httph#");d.rdf=c.Namespace("http://www.w3.org/1999/02/22-rdf-syntax-ns#");d.rdfs=c.Namespace("http://www.w3.org/2000/01/rdf-schema#");d.dc=c.Namespace("http://purl.org/dc/elements/1.1/");
c.Fetcher.crossSiteProxy=function(a){if(c.Fetcher.crossSiteProxyTemplate)return c.Fetcher.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(a))};c.Fetcher.RDFXMLHandler=function(a){a&&(this.dom=a[0]);this.handlerFactory=function(a){a.handle=function(b){var g=f.store;this.dom||(this.dom=c.Util.parseXML(a.responseText));if("parsererror"==this.dom.documentElement.nodeName)throw f.failFetch(a,"Badly formed XML in "+a.resource.uri),Error("Badly formed XML in "+a.resource.uri);var e=g.any(a.req,
d.link("requestedURI")),e=e?g.sym(e.value):a.resource;(new c.RDFParser(g)).parse(this.dom,e.uri,e);g.add(e,d.rdf("type"),d.link("RDFDocument"),f.appNode);b()}}};c.Fetcher.RDFXMLHandler.term=this.store.sym(this.thisURI+".RDFXMLHandler");c.Fetcher.RDFXMLHandler.toString=function(){return"RDFXMLHandler"};c.Fetcher.RDFXMLHandler.register=function(a){a.mediatypes["application/rdf+xml"]={}};c.Fetcher.RDFXMLHandler.pattern=/application\/rdf\+xml/;c.Fetcher.doGRDDL=function(a,b,c,d){f.requestURI("http://www.w3.org/2005/08/online_xslt/xslt?xslfile="+
escape(c)+"&xmlfile="+escape(d),b)};c.Fetcher.XHTMLHandler=function(a){a&&(this.dom=a[0]);this.handlerFactory=function(a){a.handle=function(b){this.dom||(this.dom=("undefined"!=typeof tabulator&&tabulator.isExtension?Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser):new DOMParser).parseFromString(a.responseText,"application/xml"));var g=f.store,e=this.dom.getElementsByTagName("title");0<e.length&&g.add(a.resource,d.dc("title"),g.literal(e[0].textContent),
a.resource);for(var e=this.dom.getElementsByTagName("link"),h=e.length-1;0<=h;h--)f.linkData(a,e[h].getAttribute("rel"),e[h].getAttribute("href"));(e=this.dom.getElementsByTagName("head")[0])&&(e=e.getAttribute("profile"))&&"http"==c.uri.protocol(e)&&c.Fetcher.doGRDDL(g,a.resource,"http://www.w3.org/2003/11/rdf-in-xhtml-processor",a.resource.uri);g.add(a.resource,d.rdf("type"),d.link("WebPage"),f.appNode);c.rdfa&&c.rdfa.parse&&c.rdfa.parse(this.dom,g,a.resource.uri);b()}}};c.Fetcher.XHTMLHandler.term=
this.store.sym(this.thisURI+".XHTMLHandler");c.Fetcher.XHTMLHandler.toString=function(){return"XHTMLHandler"};c.Fetcher.XHTMLHandler.register=function(a){a.mediatypes["application/xhtml+xml"]={q:.3}};c.Fetcher.XHTMLHandler.pattern=/application\/xhtml/;c.Fetcher.XMLHandler=function(){this.handlerFactory=function(a){a.handle=function(b){for(var d=f.store,e=("undefined"!=typeof tabulator&&tabulator.isExtension?Components.classes["@mozilla.org/xmlextras/domparser;1"].getService(Components.interfaces.nsIDOMParser):
new DOMParser).parseFromString(a.responseText,"application/xml"),h=0;h<e.childNodes.length;h++)if(1==e.childNodes[h].nodeType){h=e.childNodes[h].namespaceURI;if(void 0!=h&&h==h.rdf){f.addStatus(a.req,"Has XML root element in the RDF namespace, so assume RDF/XML.");f.switchHandler("RDFXMLHandler",a,b,[e]);return}for(var h=d.each(d.sym(h),d.sym("http://www.w3.org/2003/g/data-view#namespaceTransformation")),q=0;q<h.length;q++)c.Fetcher.doGRDDL(d,a.resource,h[q].uri,a.resource.uri);break}if(e.doctype&&
"html"==e.doctype.name&&e.doctype.publicId.match(/^-\/\/W3C\/\/DTD XHTML/)&&e.doctype.systemId.match(/http:\/\/www.w3.org\/TR\/xhtml/))f.addStatus(a.req,"Has XHTML DOCTYPE. Switching to XHTML Handler.\n"),f.switchHandler("XHTMLHandler",a,b);else{if((d=e.getElementsByTagName("html")[0])&&(d=d.getAttribute("xmlns"))&&d.match(/^http:\/\/www.w3.org\/1999\/xhtml/)){f.addStatus(a.req,"Has a default namespace for XHTML. Switching to XHTMLHandler.\n");f.switchHandler("XHTMLHandler",a,b);return}f.failFetch(a,
"Unsupported dialect of XML: not RDF or XHTML namespace, etc.\n"+a.responseText.slice(0,80))}}}};c.Fetcher.XMLHandler.term=this.store.sym(this.thisURI+".XMLHandler");c.Fetcher.XMLHandler.toString=function(){return"XMLHandler"};c.Fetcher.XMLHandler.register=function(a){a.mediatypes["text/xml"]={q:.2};a.mediatypes["application/xml"]={q:.2}};c.Fetcher.XMLHandler.pattern=/(text|application)\/(.*)xml/;c.Fetcher.HTMLHandler=function(){this.handlerFactory=function(a){a.handle=function(b){var c=a.responseText;
if(c.match(/\s*<\?xml\s+version\s*=[^<>]+\?>/))f.addStatus(a.req,"Has an XML declaration. We'll assume it's XHTML as the content-type was text/html.\n"),f.switchHandler("XHTMLHandler",a,b);else if(c.match(/.*<!DOCTYPE\s+html[^<]+-\/\/W3C\/\/DTD XHTML[^<]+http:\/\/www.w3.org\/TR\/xhtml[^<]+>/))f.addStatus(a.req,"Has XHTML DOCTYPE. Switching to XHTMLHandler.\n"),f.switchHandler("XHTMLHandler",a,b);else if(c.match(/[^(<html)]*<html\s+[^<]*xmlns=['"]http:\/\/www.w3.org\/1999\/xhtml["'][^<]*>/))f.addStatus(a.req,
"Has default namespace for XHTML, so switching to XHTMLHandler.\n"),f.switchHandler("XHTMLHandler",a,b);else if(c=/<title>([\s\S]+?)<\/title>/im.exec(c)){var e=f.store;e.add(a.resource,d.dc("title"),e.literal(c[1]),a.resource);e.add(a.resource,d.rdf("type"),d.link("WebPage"),f.appNode);b()}else f.failFetch(a,"Sorry, can't yet parse non-XML HTML")}}};c.Fetcher.HTMLHandler.term=this.store.sym(this.thisURI+".HTMLHandler");c.Fetcher.HTMLHandler.toString=function(){return"HTMLHandler"};c.Fetcher.HTMLHandler.register=
function(a){a.mediatypes["text/html"]={q:.3}};c.Fetcher.HTMLHandler.pattern=/text\/html/;c.Fetcher.TextHandler=function(){this.handlerFactory=function(a){a.handle=function(b){var c=a.responseText;c.match(/\s*<\?xml\s+version\s*=[^<>]+\?>/)?(f.addStatus(a.req,"Warning: "+a.resource+" has an XML declaration. We'll assume it's XML but its content-type wasn't XML.\n"),f.switchHandler("XMLHandler",a,b)):c.slice(0,500).match(/xmlns:/)?(f.addStatus(a.req,"May have an XML namespace. We'll assume it's XML but its content-type wasn't XML.\n"),
f.switchHandler("XMLHandler",a,b)):(f.addStatus(a.req,"Plain text document, no known RDF semantics."),f.doneFetch(a,[a.resource.uri]))}}};c.Fetcher.TextHandler.term=this.store.sym(this.thisURI+".TextHandler");c.Fetcher.TextHandler.toString=function(){return"TextHandler"};c.Fetcher.TextHandler.register=function(a){a.mediatypes["text/plain"]={q:.1}};c.Fetcher.TextHandler.pattern=/text\/plain/;c.Fetcher.N3Handler=function(){this.handlerFactory=function(a){a.handle=function(b){c.log.debug("web.js: Parsing as N3 "+
a.resource.uri);b=c.N3Parser(h,h,a.resource.uri,a.resource.uri,null,null,"",null);try{b.loadBuf(a.responseText)}catch(e){f.failFetch(a,"Error trying to parse "+a.resource+" as Notation3:\n"+e+":\n"+e.stack);return}f.addStatus(a.req,"N3 parsed: "+b.statementCount+" triples in "+b.lines+" lines.");f.store.add(a.resource,d.rdf("type"),d.link("RDFDocument"),f.appNode);args=[a.resource.uri];f.doneFetch(a,args)}}};c.Fetcher.N3Handler.term=this.store.sym(this.thisURI+".N3Handler");c.Fetcher.N3Handler.toString=
function(){return"N3Handler"};c.Fetcher.N3Handler.register=function(a){a.mediatypes["text/n3"]={q:"1.0"};a.mediatypes["application/x-turtle"]={q:1};a.mediatypes["text/turtle"]={q:1}};c.Fetcher.N3Handler.pattern=/(application|text)\/(x-)?(rdf\+)?(n3|turtle)/;c.Util.callbackify(this,"request recv headers load fail refresh retract done".split(" "));this.addProtocol=function(a){f.store.add(f.appNode,d.link("protocol"),f.store.literal(a),this.appNode)};this.addHandler=function(a){f.handlers.push(a);a.register(f)};
this.switchHandler=function(a,b,d,e){for(var h=null,q=0;q<this.handlers.length;q++)""+this.handlers[q]==a&&(h=this.handlers[q]);if(void 0==h)throw"web.js: switchHandler: name="+a+" , this.handlers ="+this.handlers+"\nswitchHandler: switching to "+h+"; sf="+f+"; typeof $rdf.Fetcher="+typeof c.Fetcher+";\n\t $rdf.Fetcher.HTMLHandler="+c.Fetcher.HTMLHandler+"\n\n\tsf.handlers="+f.handlers+"\n";(new h(e)).handlerFactory(b);b.handle(d)};this.addStatus=function(a,b){var e=new Date;b="["+e.getHours()+":"+
e.getMinutes()+":"+e.getSeconds()+"."+e.getMilliseconds()+"] "+b;var e=this.store,f=e.the(a,d.link("status"));f&&f.append?f.append(e.literal(b)):c.log.warn("web.js: No list to add to: "+f+","+b)};this.failFetch=function(a,b){this.addStatus(a.req,b);h.add(a.resource,d.link("error"),b);this.requested[c.uri.docpart(a.resource.uri)]=!1;a.userCallback&&a.userCallback(!1,"Fetch of <"+a.resource.uri+"> failed: "+b,a);this.fireCallbacks("fail",[a.requestedURI,b]);a.abort();return a};this.linkData=function(a,
b,e){!e||"alternate"!=b&&"seeAlso"!=b&&"meta"!=b&&"describedby"!=b||(b=h.sym(c.uri.join(e,a.resource.uri)),b.uri!=a.resource&&h.add(a.resource,d.rdfs("seeAlso"),b,a.resource))};this.doneFetch=function(a,b){this.addStatus(a.req,"Done.");this.requested[a.resource.uri]="done";a.userCallback&&a.userCallback(!0,void 0,a);this.fireCallbacks("done",b)};this.store.add(this.appNode,d.rdfs("label"),this.store.literal("This Session"),this.appNode);["http","https","file","chrome"].map(this.addProtocol);[c.Fetcher.RDFXMLHandler,
c.Fetcher.XHTMLHandler,c.Fetcher.XMLHandler,c.Fetcher.HTMLHandler,c.Fetcher.TextHandler,c.Fetcher.N3Handler].map(this.addHandler);this.nowKnownAs=function(a,b){this.lookedUp[a.uri]?this.lookedUp[b.uri]||this.lookUpThing(b,a):this.lookedUp[b.uri]&&(this.lookedUp[a.uri]||this.lookUpThing(a,b))};this.lookUpThing=function(a,b,d,e,f){a=h.uris(a);var q=!0,t="",w={};if("undefined"!==typeof a)for(var r=0;r<a.length;r++){var A=a[r];w[A]=!0;this.lookedUp[A]=!0;var B=this;(function(a){B.requestURI(c.uri.docpart(a),
b,d,function(b,c,d){b?e&&e(!0,a):(e&&e(!1,c),q=!1,t+=c+"\n");delete w[A];for(x in w)return;f&&f(q,t)})})(A)}return a.length};this.nowOrWhenFetched=function(a,b,c){if("fetched"==this.getState(a))return c(!0);this.requestURI(a,b,!1,c)};this.getHeader=function(a,b){for(var c=this.store,d=c.each(void 0,tabulator.ns.link("requestedURI"),a.uri),e=0;e<d.length;e++){var f=d[e];if(void 0!==f){var h=c.any(f,tabulator.ns.link("response"));if(void 0!==f)return c=c.each(h,tabulator.ns.httph(b.toLowerCase())),
c.length?c.map(function(a){return a.value}):[]}}};this.proxyIfNecessary=function(a){return"undefined"!=typeof tabulator&&tabulator.isExtension?a:c.Fetcher.crossSiteProxyTemplate&&document&&document.location&&"https:"===(""+document.location).slice(0,6)&&"http:"===a.slice(0,5)?c.Fetcher.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(a)):a};this.requestURI=function(a,b,e,f){if(0<=a.indexOf("#"))throw"requestURI should not be called with fragid: "+a;var h=c.uri.protocol(a);if("tel"==h||"mailto"==
h||"urn"==h)return null;e=!!e;var q=this.store,t=arguments,w=q.sym(a);if(!e&&"undefined"!=typeof this.requested[a])return null;this.fireCallbacks("request",t);this.requested[a]=!0;b&&b.uri&&q.add(w.uri,d.link("requestedBy"),b.uri,this.appNode);if(h="undefined"!=typeof jQuery)A=q.bnode();else{var r=c.Util.XMLHTTPFactory(),A=r.req=q.bnode();r.resource=w;r.requestedURI=t[0]}var B=q.collection(),n=this,u=new Date,u="["+u.getHours()+":"+u.getMinutes()+":"+u.getSeconds()+"] ";q.add(A,d.rdfs("label"),q.literal(u+
" Request for "+a),this.appNode);q.add(A,d.link("requestedURI"),q.literal(a),this.appNode);q.add(A,d.link("status"),q.collection(),n.req);var C=function(a){return function(b){if(c.Fetcher.crossSiteProxyTemplate&&document&&document.location&&!a.proxyUsed){b=c.uri.hostpart;var g=""+document.location,h=a.resource.uri;b(g)&&b(h)&&b(g)!=b(h)&&(newURI=c.Fetcher.crossSiteProxy(h),n.addStatus(a.req,"BLOCKED -> Cross-site Proxy to <"+newURI+">"),a.aborted||(b=n.store,g=a.req,b.add(g,d.http("redirectedTo"),
b.sym(newURI),g),a.abort(),a.aborted=!0,n.addStatus(g,"done - redirected"),n.requested[a.resource.uri]="redirected",g=n.requestURI(newURI,a.resource,e,f),g.proxyUsed=!0,g&&g.req&&b.add(a.req,b.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),g.req,n.appNode)))}else a.withCredentials?(a.abort(),a.withCredentials=!1,n.addStatus(a.req,"Credentials SUPPRESSED to see if that helps"),a.send()):n.failFetch(a,"XHR Error: "+b)}},H=function(b){return function(){var f=function(){if(!b.handleResponseDone){b.handleResponseDone=
!0;var f=null,h=b.req;n.fireCallbacks("recv",t);var k=n.store,m=k.bnode();k.add(h,d.link("response"),m);k.add(m,d.http("status"),k.literal(b.status),m);k.add(m,d.http("statusText"),k.literal(b.statusText),m);b.headers={};if("http"==c.uri.protocol(b.resource.uri)||"https"==c.uri.protocol(b.resource.uri)){b.headers=c.Util.getHTTPHeaders(b);for(var p in b.headers)k.add(m,d.httph(p.toLowerCase()),b.headers[p].trim(),m)}n.fireCallbacks("headers",[{uri:a,headers:b.headers}]);if(400<=b.status)10<b.responseText.length&&
k.add(m,d.http("content"),k.literal(b.responseText),m),n.failFetch(b,"HTTP error for "+b.resource+": "+b.status+" "+b.statusText);else{var q=b.headers["content-location"],m=function(a){var b=h;for(q&&k.any(b,d.link("requestedURI"))!=q&&k.add(k.sym(q),d.rdf("type"),a,n.appNode);;){var c=k.any(b,d.link("requestedURI"));c&&c.value&&k.add(k.sym(c.value),d.rdf("type"),a,n.appNode);b=k.any(void 0,k.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),b);if(!b)break;c=k.any(b,k.sym("http://www.w3.org/2007/ont/link#response"));
if(!c)break;c=k.any(c,k.sym("http://www.w3.org/2007/ont/http#status"));if(!c)break;if("301"!=c&&"302"!=c)break}};200==b.status&&(m(d.link("Document")),(p=b.headers["content-type"])&&(0!=p.indexOf("image/")&&0!=p.indexOf("application/pdf")||m(k.sym("http://purl.org/dc/terms/Image"))));if("file"==c.uri.protocol(b.resource.uri)||"chrome"==c.uri.protocol(b.resource.uri))switch(b.resource.uri.split(".").pop()){case "rdf":case "owl":b.headers["content-type"]="application/rdf+xml";break;case "n3":case "nt":case "ttl":b.headers["content-type"]=
"text/n3";break;default:b.headers["content-type"]="text/xml"}if(q){m=c.uri.join(b.resource.uri,q);if(!e&&m!=b.resource.uri&&n.requested[m]){n.doneFetch(b,t);b.abort();return}n.requested[m]=!0}for(m=0;m<n.handlers.length;m++)if(b.headers["content-type"]&&b.headers["content-type"].match(n.handlers[m].pattern)){f=new n.handlers[m];B.append(n.handlers[m].term);break}var r;try{r=b.getResponseHeader("link")}catch(E){}if(r){m=null;r=r.replace(/ /g,"").split(";");for(p=1;p<r.length;p++)lr=r[p].split("="),
"rel"==lr[0]&&(m=lr[1]);r=r[0];r.length&&"<"==r[0]&&">"==r[r.length-1]&&r.slice&&(r=r.slice(1,-1));m&&n.linkData(b,m,r)}if(f)try{f.handlerFactory(b)}catch(D){n.failFetch(b,"Exception handling content-type "+b.headers["content-type"]+" was: "+D)}else n.doneFetch(b,t)}}};switch(b.readyState){case 0:var f=b.resource.uri,h;if(this.crossSiteProxyTemplate&&document&&document.location){h=c.uri.hostpart;var k=""+document.location;if(h(k)&&h(f)&&h(k)!=h(f)){h=this.crossSiteProxyTemplate.replace("{uri}",encodeURIComponent(f));
n.addStatus(b.req,"BLOCKED -> Cross-site Proxy to <"+h+">");if(b.aborted)break;f=n.store;k=b.req;f.add(k,d.http("redirectedTo"),f.sym(h),k);var m=b.req=f.bnode();f.add(k,d.http("redirectedRequest"),m,b.req);var p=new Date,p="["+p.getHours()+":"+p.getMinutes()+":"+p.getSeconds()+"] ";f.add(m,d.rdfs("label"),f.literal(p+" Request for "+h),this.appNode);f.add(m,d.link("status"),f.collection(),n.req);f.add(m,d.link("requestedURI"),f.literal(h),this.appNode);m=f.bnode();f.add(k,d.link("response"),m);b.abort();
b.aborted=!0;n.addStatus(k,"done");b.userCallback&&b.userCallback(!0);n.fireCallbacks("done",t);n.requested[b.resource.uri]="redirected";(h=n.requestURI(h,b.resource))&&h.req&&f.add(b.req,f.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),h.req,n.appNode);break}}n.failFetch(b,"HTTP Blocked. (ReadyState 0) Cross-site violation for <"+a+">");break;case 4:if(f(),b.handle){if("redirected"===n.requested[b.resource.uri])break;n.fireCallbacks("load",t);b.handle(function(){n.doneFetch(b,t)})}else n.addStatus(b.req,
"Fetch OK. No known semantics."),n.doneFetch(b,t)}}},I=a;"undefined"!=typeof tabulator&&tabulator.preferences.get("offlineModeUsingLocalhost")&&"http://"==I.slice(0,7)&&"localhost/"!=I.slice(7,17)&&(I="http://localhost/"+I.slice(7),c.log.warn("Localhost kludge for offline use: actually getting <"+I+">"));q="https:"===I.slice(0,6);u=this.proxyIfNecessary(I);if("undefined"!==typeof jQuery&&jQuery.ajax)r=jQuery.ajax({url:u,accepts:{"*":"text/turtle,text/n3,application/rdf+xml"},processData:!1,xhrFields:{withCredentials:q},
timeout:n.timeout,error:function(a,b,c){a.req=A;a.userCallback=f;a.resource=w;a.requestedURI=I;"timeout"==b?n.failFetch(a,"requestTimeout"):C(a)(c)},success:function(a,b,c){c.req=A;c.userCallback=f;c.resource=w;c.requestedURI=I;H(c)()}}),r.req=A,r.userCallback=f,r.resource=w,r.requestedURI=I,r.actualProxyURI=u;else{r=c.Util.XMLHTTPFactory();r.onerror=C(r);r.onreadystatechange=H(r);r.timeout=n.timeout;r.withCredentials=q;r.actualProxyURI=u;r.req=A;r.userCallback=f;r.resource=w;r.requestedURI=I;r.ontimeout=
function(){n.failFetch(r,"requestTimeout")};try{r.open("GET",u,this.async)}catch(L){return this.failFetch(r,"XHR open for GET failed for <"+I+">:\n\t"+L)}}if("undefined"!=typeof tabulator&&tabulator.isExtension&&r.channel&&("http"==c.uri.protocol(r.resource.uri)||"https"==c.uri.protocol(r.resource.uri)))try{r.channel.notificationCallbacks={getInterface:function(a){return a.equals(Components.interfaces.nsIChannelEventSink)?{onChannelRedirect:function(a,e,f){if(!r.aborted){a=n.store;e=e.URI.spec;f=
r.req;n.addStatus(r.req,"Redirected: "+r.status+" to <"+e+">");a.add(f,d.http("redirectedTo"),a.sym(e),r.req);var g=r.req=a.bnode();a.add(f,d.http("redirectedRequest"),g,r.req);var h=new Date,h="["+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds()+"] ";a.add(g,d.rdfs("label"),a.literal(h+" Request for "+e),this.appNode);a.add(g,d.link("status"),a.collection(),n.req);a.add(g,d.link("requestedURI"),a.literal(e),this.appNode);g=a.bnode();a.add(f,d.link("response"),g);a.add(g,d.http("status"),a.literal(r.status),
g);r.statusText&&a.add(g,d.http("statusText"),a.literal(r.statusText),g);303!=r.status-0&&(a.HTTPRedirects[r.resource.uri]=e);301==r.status-0&&b&&(h=c.uri.docpart(b.uri),g="Warning: "+r.resource+" has moved to <"+e+">.",b&&(g+=" Link in <"+h+" >should be changed",a.add(h,a.sym("http://www.w3.org/2007/ont/link#warning"),g,n.appNode)));r.abort();r.aborted=!0;n.addStatus(f,"done");n.fireCallbacks("done",t);n.requested[r.resource.uri]="redirected";f=e.indexOf("#");0<=f&&(g="Warning: "+r.resource+" HTTP redirects to"+
e+' which should not contain a "#" sign',a.add(r.resource,a.sym("http://www.w3.org/2007/ont/link#warning"),g),e=e.slice(0,f));(e=n.requestURI(e,r.resource))&&e.req&&a.add(r.req,a.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),e.req,n.appNode)}},asyncOnChannelRedirect:function(a,e,f,g){if(!r.aborted){a=n.store;e=e.URI.spec;f=r.req;n.addStatus(r.req,"Redirected: "+r.status+" to <"+e+">");a.add(f,d.http("redirectedTo"),a.sym(e),r.req);g=r.req=a.bnode();a.add(f,d.http("redirectedRequest"),g,
r.req);var h=new Date,h="["+h.getHours()+":"+h.getMinutes()+":"+h.getSeconds()+"] ";a.add(g,d.rdfs("label"),a.literal(h+" Request for "+e),this.appNode);a.add(g,d.link("status"),a.collection(),n.req);a.add(g,d.link("requestedURI"),a.literal(e),this.appNode);g=a.bnode();a.add(f,d.link("response"),g);a.add(g,d.http("status"),a.literal(r.status),g);r.statusText&&a.add(g,d.http("statusText"),a.literal(r.statusText),g);303!=r.status-0&&(a.HTTPRedirects[r.resource.uri]=e);301==r.status-0&&b&&(h=c.uri.docpart(b.uri),
g="Warning: "+r.resource+" has moved to <"+e+">.",b&&(g+=" Link in <"+h+" >should be changed",a.add(h,a.sym("http://www.w3.org/2007/ont/link#warning"),g,n.appNode)));r.abort();r.aborted=!0;n.addStatus(f,"done");r.userCallback&&r.userCallback(!0);n.fireCallbacks("done",t);n.requested[r.resource.uri]="redirected";f=e.indexOf("#");0<=f&&(g="Warning: "+r.resource+" HTTP redirects to"+e+' which should not contain a "#" sign',a.add(r.resource,a.sym("http://www.w3.org/2007/ont/link#warning"),g),e=e.slice(0,
f));(e=n.requestURI(e,r.resource))&&e.req&&a.add(r.req,a.sym("http://www.w3.org/2007/ont/link#redirectedRequest"),e.req,n.appNode)}}}:Components.results.NS_NOINTERFACE}}}catch(N){return n.failFetch(r,"@@ Couldn't set callback for redirects: "+N)}try{var q="",K;for(K in this.mediatypes){""!=q&&(q+=", ");var q=q+K,O;for(O in this.mediatypes[K])q+=";"+O+"="+this.mediatypes[K][O]}r.setRequestHeader("Accept",q)}catch(F){throw"Can't set Accept header: "+F;}if(h)this.addStatus(r.req,"HTTP Request sent (using jQuery)");
else{try{r.send(null)}catch(G){return this.failFetch(r,"XHR send failed:"+G)}setTimeout(function(){4!=r.readyState&&n.isPending(r.resource.uri)&&n.failFetch(r,"requestTimeout")},this.timeout);this.addStatus(r.req,"HTTP Request sent.")}return r};this.objectRefresh=function(a){a=h.uris(a);if("undefined"!=typeof a)for(var b=0;b<a.length;b++)this.refresh(this.store.sym(c.uri.docpart(a[b])))};this.unload=function(a){this.store.removeMany(void 0,void 0,void 0,a);delete this.requested[a.uri]};this.refresh=
function(a){this.unload(a);this.fireCallbacks("refresh",arguments);this.requestURI(a.uri,void 0,!0)};this.retract=function(a){this.store.removeMany(void 0,void 0,void 0,a);a.uri&&delete this.requested[c.uri.docpart(a.uri)];this.fireCallbacks("retract",arguments)};this.getState=function(a){return"undefined"!=typeof this.requested[a]?this.requested[a]?this.isPending(a)?"requested":"fetched":"failed":"unrequested"};this.isPending=function(a){return 1==this.requested[a]}};c.fetcher=function(b,a,e){return new c.Fetcher(b,
a,e)};c.parse=function(b,a,e,f){try{if("text/n3"==f||"text/turtle"==f){c.N3Parser(a,a,e,e,null,null,"",null).loadBuf(b);return}if("application/rdf+xml"==f){(new c.RDFParser(a)).parse(c.Util.parseXML(b),e,a.sym(e));return}if("application/rdfa"==f){c.rdfa&&c.rdfa.parse&&c.rdfa.parse(c.Util.parseXML(b),a,e);return}if("application/sparql-update"==f){spaqlUpdateParser(store,b,e);c.rdfa&&c.rdfa.parse&&c.rdfa.parse(c.Util.parseXML(b),a,e);return}}catch(h){throw"Error trying to parse <"+e+"> as "+f+":\n"+
h+":\n"+h.stack;}throw"Don't know how to parse "+f+" yet";};c.serialize=function(b,a,e,f){var h=c.Serializer(a);b=a.statementsMatching(void 0,void 0,void 0,b);h.suggestNamespaces(a.namespaces);h.setBase(e);switch(f){case "application/rdf+xml":a=h.statementsToXML(b);break;case "text/n3":case "text/turtle":case "application/x-turtle":case "application/n3":a=h.statementsToN3(b);break;default:throw"serialise: Content-type "+content_type+" not supported for data write";}return a};"undefined"!==typeof exports?
("undefined"!==typeof module&&module.exports&&(exports=module.exports=c),exports.$rdf=c):("function"===typeof define&&define.amd&&define([],function(){return c}),T.$rdf=c)})(this);